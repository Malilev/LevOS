<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LEV OS 2.0">
  <title>ü¶Å LEV OS 2.0</title>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { margin: 0; background: #111827; overscroll-behavior: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    input, select, button, textarea { font-family: inherit; }
    .safe-top { padding-top: env(safe-area-inset-top, 0px); }
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); }
    .timeline-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .timeline-scroll::-webkit-scrollbar-track { background: #1f2937; }
    .timeline-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAsx9QPTbMbTUUXiM2MQxNrUZUxbE13uW4",
      authDomain: "levos2.firebaseapp.com",
      databaseURL: "https://levos2-default-rtdb.europe-west1.firebasedatabase.app", // –û–±–Ω–æ–≤–∏ –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω
      projectId: "levos2",
      storageBucket: "levos2.firebasestorage.app",
      messagingSenderId: "1045375644720",
      appId: "1:1045375644720:web:fd0ad80d9336dfe444e9f5"
    };

    // Initialize Firebase
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Firebase sync state
    let firebaseUserId = null;
    let firebaseReady = false;
    let firebaseUser = null;

    // Google Auth provider
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // Auth state listener
    auth.onAuthStateChanged((user) => {
      if (user) {
        firebaseUserId = user.uid;
        firebaseUser = user;
        firebaseReady = true;
        console.log('Firebase ready, user:', user.displayName || user.uid);
        window.dispatchEvent(new Event('firebase-ready'));
      } else {
        firebaseUserId = null;
        firebaseUser = null;
        firebaseReady = false;
      }
      window.dispatchEvent(new Event('firebase-auth-changed'));
    });

    // Sign in with Google
    function signInWithGoogle() {
      return auth.signInWithPopup(googleProvider);
    }

    // Sign out
    function signOutFirebase() {
      return auth.signOut();
    }
  </script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // Local storage (fallback + cache)
    const localStorage_ = {
      get: (key, def) => { try { const item = localStorage.getItem(`levos2_${key}`); return item ? JSON.parse(item) : def; } catch { return def; } },
      set: (key, value) => { try { localStorage.setItem(`levos2_${key}`, JSON.stringify(value)); } catch {} }
    };

    // Hybrid storage: localStorage + Firebase sync
    const storage = {
      get: (key, def) => localStorage_.get(key, def),
      set: (key, value) => {
        localStorage_.set(key, value);
        // Sync to Firebase
        if (firebaseReady && firebaseUserId) {
          database.ref(`users/${firebaseUserId}/${key}`).set(value);
        }
      }
    };

    const SLOT_HEIGHT = 18;
    const TIME_SLOTS = [];
    // –ü–æ–ª–Ω—ã–π –¥–µ–Ω—å: 00:00 - 23:30 + –Ω–æ—á—å –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ (24:00 - 28:00 = 00:00 - 04:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è)
    for (let i = 0; i < 24; i++) { TIME_SLOTS.push({ hour: i, label: `${i.toString().padStart(2, '0')}`, isHalf: false }); TIME_SLOTS.push({ hour: i + 0.5, label: '', isHalf: true }); }
    // –ü–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ (–¥–ª—è —Å–Ω–∞) - 24:00 –¥–æ 28:00 = 00:00 –¥–æ 04:00
    TIME_SLOTS.push({ hour: 24, label: '00', isHalf: false, isMidnight: true });
    TIME_SLOTS.push({ hour: 24.5, label: '', isHalf: true });
    TIME_SLOTS.push({ hour: 25, label: '01', isHalf: false, isNight: true });
    TIME_SLOTS.push({ hour: 25.5, label: '', isHalf: true });
    TIME_SLOTS.push({ hour: 26, label: '02', isHalf: false, isNight: true });
    TIME_SLOTS.push({ hour: 26.5, label: '', isHalf: true });
    TIME_SLOTS.push({ hour: 27, label: '03', isHalf: false, isNight: true });
    TIME_SLOTS.push({ hour: 27.5, label: '', isHalf: true });
    TIME_SLOTS.push({ hour: 28, label: '04', isHalf: false, isNight: true });

    const roundToHalfHour = (hour) => Math.round(hour * 2) / 2;

    const CATEGORIES = {
      OP: { name: '–û–ø–µ—Ä–∞—Ü–∏–∏', color: '#EF4444' },
      SACRED: { name: '–°–µ–º—å—è', color: '#A855F7' },
      POLECHAT: { name: '–ü–æ–ª–µ—á–∞—Ç', color: '#3B82F6' },
      SOMALAB: { name: '–°–æ–º–∞–ª–∞–±', color: '#F97316' },
      LAB: { name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', color: '#8B5CF6' },
      CARE: { name: '–ó–∞–±–æ—Ç–∞', color: '#22C55E' },
      BUFFER: { name: '–ë—É—Ñ–µ—Ä', color: '#6B7280' },
      NIGHT: { name: '–ù–æ—á—å', color: '#6366F1' },
      FREE: { name: '–°–≤–æ–±–æ–¥–Ω–æ–µ', color: '#EAB308' },
    };

    const DEFAULT_BLOCKS = {
      OP_1: { id: 'OP_1', name: '1 –æ–ø–µ—Ä–∞—Ü–∏—è', emoji: 'üè•', category: 'OP', color: '#EF4444', duration: 180, minDur: 120, maxDur: 240 },
      OP_2: { id: 'OP_2', name: '2 –æ–ø–µ—Ä–∞—Ü–∏–∏', emoji: 'üè•üè•', category: 'OP', color: '#DC2626', duration: 300, minDur: 240, maxDur: 420 },
      OP_3: { id: 'OP_3', name: '3 –æ–ø–µ—Ä–∞—Ü–∏–∏', emoji: 'üè•üè•üè•', category: 'OP', color: '#B91C1C', duration: 420, minDur: 360, maxDur: 540 },
      BUFFER: { id: 'BUFFER', name: '–ë—É—Ñ–µ—Ä', emoji: '‚è≥', category: 'BUFFER', color: '#6B7280', duration: 30, minDur: 15, maxDur: 60 },
      ROAD: { id: 'ROAD', name: '–î–æ—Ä–æ–≥–∞', emoji: 'üö∂', category: 'BUFFER', color: '#4B5563', duration: 25, minDur: 20, maxDur: 40 },
      FAM: { id: 'FAM', name: '50 –º–∏–Ω –ú–∞–π', emoji: 'üë®‚Äçüë©‚Äçüëß', category: 'SACRED', color: '#A855F7', duration: 50, minDur: 30, maxDur: 120 },
      WALK: { id: 'WALK', name: '–ü—Ä–æ–≥—É–ª–∫–∞ –ú–∞–π', emoji: 'üö∂‚Äç‚ôÇÔ∏è', category: 'SACRED', color: '#9333EA', duration: 90, minDur: 60, maxDur: 120 },
      POLECHAT: { id: 'POLECHAT', name: '–ü–æ–ª–µ—á–∞—Ç', emoji: 'üíº', category: 'POLECHAT', color: '#3B82F6', duration: 120, minDur: 30, maxDur: 300 },
      CALL_P: { id: 'CALL_P', name: '–ó–≤–æ–Ω–æ–∫ –ü–æ–ª–µ—á–∞—Ç', emoji: 'üìûüíº', category: 'POLECHAT', color: '#2563EB', duration: 60, minDur: 30, maxDur: 90 },
      SOMALAB: { id: 'SOMALAB', name: '–°–æ–º–∞–ª–∞–±', emoji: '‚ö°', category: 'SOMALAB', color: '#F97316', duration: 90, minDur: 30, maxDur: 180 },
      CALL_S: { id: 'CALL_S', name: '–ó–≤–æ–Ω–æ–∫ –°–æ–º–∞–ª–∞–±', emoji: 'üìû‚ö°', category: 'SOMALAB', color: '#EA580C', duration: 60, minDur: 30, maxDur: 90 },
      LAB: { id: 'LAB', name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', emoji: 'üî¨', category: 'LAB', color: '#8B5CF6', duration: 120, minDur: 60, maxDur: 240 },
      SPORT: { id: 'SPORT', name: '–°–ø–æ—Ä—Ç', emoji: 'üèãÔ∏è', category: 'CARE', color: '#22C55E', duration: 90, minDur: 60, maxDur: 150 },
      SPORT_SPA: { id: 'SPORT_SPA', name: '–°–ø–æ—Ä—Ç+–°–ü–ê', emoji: 'üèãÔ∏èüßñ', category: 'CARE', color: '#16A34A', duration: 150, minDur: 120, maxDur: 180 },
      NAP: { id: 'NAP', name: 'Power Nap', emoji: 'üí§', category: 'CARE', color: '#14B8A6', duration: 30, minDur: 20, maxDur: 45 },
      SLEEP: { id: 'SLEEP', name: '–°–æ–Ω', emoji: 'üò¥', category: 'NIGHT', color: '#6366F1', duration: 480, minDur: 360, maxDur: 540 },
      HYPER: { id: 'HYPER', name: '–ì–∏–ø–µ—Ä—Ñ–æ–∫—É—Å', emoji: 'üî•', category: 'FREE', color: '#F59E0B', duration: 180, minDur: 120, maxDur: 360 },
      FREE: { id: 'FREE', name: '–°–≤–æ–±–æ–¥–Ω–æ–µ', emoji: 'üé®', category: 'FREE', color: '#EAB308', duration: 60, minDur: 30, maxDur: 180 },
    };

    const CONTEXTS = {
      POLECHAT: { name: '–ü–æ–ª–µ—á–∞—Ç', color: '#3B82F6', emoji: 'üíº', blockId: 'POLECHAT' },
      SOMALAB: { name: '–°–æ–º–∞–ª–∞–±', color: '#F97316', emoji: '‚ö°', blockId: 'SOMALAB' },
      LAB: { name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', color: '#8B5CF6', emoji: 'üî¨', blockId: 'LAB' },
      FAMILY: { name: '–°–µ–º—å—è', color: '#22C55E', emoji: 'üë®‚Äçüë©‚Äçüëß', blockId: 'FAM' },
    };

    const DEFAULT_WEEK_CONTEXTS = {
      0: 'FAMILY', // –í—Å
      1: 'POLECHAT', // –ü–Ω
      2: 'POLECHAT', // –í—Ç
      3: 'POLECHAT', // –°—Ä
      4: 'LAB', // –ß—Ç
      5: 'SOMALAB', // –ü—Ç
      6: 'FAMILY', // –°–±
    };

    const SCENARIOS = {
      1: { name: '1-–π', desc: '–∫ 8:30', wakeUp: 7.5, opStart: 8.5, arriveBy: '8:30-8:40' },
      2: { name: '2-–π', desc: '–∫ 10:00', wakeUp: 8.5, opStart: 10, homeWindow: { start: 9, dur: 30 }, arriveBy: '10:00' },
      3: { name: '3-–π', desc: '–∫ 12:00', wakeUp: 10, opStart: 12, homeWindow: { start: 10.5, dur: 60 }, arriveBy: '12:00', note: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å —É—Ç–æ—á–Ω–∏—Ç—å! –ú–æ–∂–µ—Ç –±—ã—Ç—å 15:00' },
      4: { name: '4+', desc: '–∫ 15:00', wakeUp: 11, opStart: 15, homeWindow: { start: 11.5, dur: 180 }, canGym: true, arriveBy: '15:00' },
      w: { name: 'üè†', desc: '–≤—ã—Ö–æ–¥–Ω–æ–π', wakeUp: 11, isWeekend: true },
    };

    const PROJECTS = {
      POLECHAT: { name: '–ü–æ–ª–µ—á–∞—Ç', color: '#3B82F6', emoji: 'üíº' },
      SOMALAB: { name: '–°–æ–º–∞–ª–∞–±', color: '#F97316', emoji: '‚ö°' },
      LAB: { name: '–õ–∞–±', color: '#8B5CF6', emoji: 'üî¨' },
      FAMILY: { name: '–°–µ–º—å—è', color: '#A855F7', emoji: 'üë®‚Äçüë©‚Äçüëß' },
      PERSONAL: { name: '–õ–∏—á–Ω–æ–µ', color: '#EAB308', emoji: 'üéØ' },
    };

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –ª–æ–∫–∞—Ü–∏–π ‚Äî –≥–¥–µ —Ç—ã –∏ —á—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å
    const LOCATION_CONTEXTS = {
      OFFICE: {
        id: 'OFFICE',
        name: '–û—Ñ–∏—Å',
        emoji: 'üè¢',
        color: '#3B82F6',
        time: '2-4—á',
        interrupt: '–ù–∏–∑–∫–∞—è',
        energy: '–í—ã—Å–æ–∫–∞—è',
        tools: '–í—Å—ë',
        works: 'üî• –ì–ª—É–±–æ–∫–∞—è —Ä–∞–±–æ—Ç–∞, –≥–∏–ø–µ—Ä—Ñ–æ–∫—É—Å',
        bundle: '–õ—é–±–∏–º—ã–π –∫–æ—Ñ–µ + –≥–ª—É–±–æ–∫–∞—è —Ä–∞–±–æ—Ç–∞',
        tasks: {
          POLECHAT: '–î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ–¥, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è',
          SOMALAB: '–ì–ª—É–±–æ–∫–∏–µ –∑–∞–¥–∞—á–∏',
          LAB: '–ü–∏—Å–∞—Ç—å, –∞–Ω–∞–ª–∏–∑',
        }
      },
      HOME_NIGHT: {
        id: 'HOME_NIGHT',
        name: '–î–æ–º –Ω–æ—á—å—é',
        emoji: 'üåô',
        color: '#6366F1',
        time: '2-4—á',
        interrupt: '–ù–∏–∑–∫–∞—è',
        energy: '–°—Ä–µ–¥–Ω—è—è (—É—Å—Ç–∞–ª–æ—Å—Ç—å)',
        tools: '–í—Å—ë',
        works: 'üî• –ì–∏–ø–µ—Ä—Ñ–æ–∫—É—Å, –Ω–æ —Ä–∏—Å–∫ –¥–ª—è —Å–Ω–∞',
        bundle: '–¢–∏—à–∏–Ω–∞ + ambient –≤ –Ω–∞—É—à–Ω–∏–∫–∞—Ö + –≥–∏–ø–µ—Ä—Ñ–æ–∫—É—Å',
        tasks: {
          POLECHAT: '–ö–æ–¥, –¥—É–º–∞—Ç—å',
          LAB: '–ü–∏—Å–∞—Ç—å',
        }
      },
      ALMAZOVA: {
        id: 'ALMAZOVA',
        name: '–ê–ª–º–∞–∑–æ–≤–∞ (–æ–∂–∏–¥–∞–Ω–∏–µ)',
        emoji: 'üè•',
        color: '#EF4444',
        time: '30-120–º–∏–Ω',
        interrupt: '–í—ã—Å–æ–∫–∞—è (–≤—ã–∑–æ–≤—É—Ç)',
        energy: '–°—Ä–µ–¥–Ω—è—è',
        tools: '–¢–µ–ª–µ—Ñ–æ–Ω, –Ω–æ—É—Ç–±—É–∫',
        works: '‚ö° –†–µ–∞–∫—Ç–∏–≤: –æ—Ç–≤–µ—Ç—ã, –º–µ–ª–æ—á–∏, —á—Ç–µ–Ω–∏–µ',
        bundle: '–ß–∞–π –∏–∑ –∞–≤—Ç–æ–º–∞—Ç–∞ + —Ä–∞–∑–≥—Ä–µ—Å—Ç–∏ inbox',
        tasks: {
          POLECHAT: '–û—Ç–≤–µ—Ç–∏—Ç—å –≤ —á–∞—Ç',
          SOMALAB: '–û—Ç–≤–µ—Ç—ã',
          LAB: '–ß–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å–∏',
        },
        warning: '–ù–∏–∫–∞–∫–∏—Ö –∞–º–±–∏—Ü–∏–π! –¢–æ–ª—å–∫–æ inbox zero –∏ –º–µ–ª–æ—á–∏'
      },
      HOME_DAY: {
        id: 'HOME_DAY',
        name: '–î–æ–º –¥–Ω—ë–º',
        emoji: 'üè†',
        color: '#A855F7',
        time: '–§—Ä–∞–≥–º–µ–Ω—Ç—ã',
        interrupt: '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è',
        energy: '–ù–∏–∑–∫–∞—è',
        tools: '–í—Å—ë, –Ω–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ',
        works: 'üë®‚Äçüë©‚Äçüëß –°–µ–º—å—è. –ù–µ —Ä–∞–±–æ—Ç–∞.',
        bundle: '–í—Ä–µ–º—è —Å –ú–∞–π',
        tasks: {},
        warning: '–ù–µ –ø—ã—Ç–∞—Ç—å—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å ‚Äî —ç—Ç–æ –ª–æ–≤—É—à–∫–∞!'
      },
      ROAD_ALM: {
        id: 'ROAD_ALM',
        name: '–ü—É—Ç—å –¥–æ –ê–ª–º–∞–∑–æ–≤–∞',
        emoji: 'üö∂',
        color: '#4B5563',
        time: '25 –º–∏–Ω',
        interrupt: '–ù—É–ª–µ–≤–∞—è',
        energy: '–°–≤–µ–∂–∞—è',
        tools: '–¢–µ–ª–µ—Ñ–æ–Ω, –Ω–∞—É—à–Ω–∏–∫–∏',
        works: 'üéß –ê—É–¥–∏–æ, –∑–≤–æ–Ω–∫–∏, –≥–æ–ª–æ—Å–æ–≤—ã–µ, –æ–±–¥—É–º–∞—Ç—å',
        bundle: '–õ—é–±–∏–º—ã–π –ø–æ–¥–∫–∞—Å—Ç + –æ–±–¥—É–º–∞—Ç—å –æ–¥–Ω—É –∑–∞–¥–∞—á—É',
        tasks: {
          POLECHAT: '–ü–æ–∑–≤–æ–Ω–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä—É',
          SOMALAB: '–ó–≤–æ–Ω–æ–∫ –∫–æ–º–∞–Ω–¥–µ',
          LAB: '–ê—É–¥–∏–æ –ª–µ–∫—Ü–∏–∏',
        }
      },
      ROAD_GYM: {
        id: 'ROAD_GYM',
        name: '–ü—É—Ç—å –¥–æ –∑–∞–ª–∞',
        emoji: 'üèãÔ∏è',
        color: '#22C55E',
        time: '15-20 –º–∏–Ω',
        interrupt: '–ù—É–ª–µ–≤–∞—è',
        energy: '–°–≤–µ–∂–∞—è',
        tools: '–¢–µ–ª–µ—Ñ–æ–Ω, –Ω–∞—É—à–Ω–∏–∫–∏',
        works: 'üéß –ê—É–¥–∏–æ, –∑–≤–æ–Ω–∫–∏, –≥–æ–ª–æ—Å–æ–≤—ã–µ',
        bundle: '–≠–Ω–µ—Ä–≥–∏—á–Ω–∞—è –º—É–∑—ã–∫–∞ / –ø–æ–¥–∫–∞—Å—Ç',
        tasks: {}
      },
      WALK: {
        id: 'WALK',
        name: '–ü—Ä–æ–≥—É–ª–∫–∞ —Å –ú–∞–π',
        emoji: 'üö∂‚Äç‚ôÇÔ∏è',
        color: '#9333EA',
        time: '1-2—á',
        interrupt: '–ù–∏–∑–∫–∞—è',
        energy: '–°—Ä–µ–¥–Ω—è—è',
        tools: '–ì–æ–ª–æ—Å, –Ω–∞—É—à–Ω–∏–∫–∏',
        works: 'üéß –ü–æ–¥–∫–∞—Å—Ç—ã, –æ–±–¥—É–º—ã–≤–∞–Ω–∏–µ, –¥–∏–∫—Ç–æ–≤–∫–∞',
        bundle: '–°–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö + –Ω–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å –º—ã—Å–ª–∏',
        tasks: {
          POLECHAT: '–û–±–¥—É–º–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
          LAB: '–û–±–¥—É–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É',
        }
      },
      CAFE: {
        id: 'CAFE',
        name: '–ö–∞—Ñ–µ (–≤—Å—Ç—Ä–µ—á–∞)',
        emoji: '‚òï',
        color: '#F59E0B',
        time: '–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ',
        interrupt: '–ù—É–ª–µ–≤–∞—è',
        energy: '–í—ã—Å–æ–∫–∞—è',
        tools: '–†–∞–∑–≥–æ–≤–æ—Ä',
        works: 'ü§ù –¢–æ–ª—å–∫–æ –≤—Å—Ç—Ä–µ—á–∏',
        bundle: '–•–æ—Ä–æ—à–∏–π –∫–æ—Ñ–µ + –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä',
        tasks: {}
      },
      OPERATING: {
        id: 'OPERATING',
        name: '–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è',
        emoji: '‚öïÔ∏è',
        color: '#DC2626',
        time: '3-8—á',
        interrupt: '–ù—É–ª–µ–≤–∞—è',
        energy: '100% —Ç—É–¥–∞',
        tools: '–ù–∏—á–µ–≥–æ',
        works: 'üè• –•–∏—Ä—É—Ä–≥–∏—è. –¢–æ—á–∫–∞.',
        bundle: '',
        tasks: {},
        warning: '100% —Ñ–æ–∫—É—Å –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'
      },
    };

    // –ü–æ–ª–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
    const getTriggers = (scenario, dayOfWeek, context) => {
      const contextName = CONTEXTS[context]?.name || '';

      const sections = [];

      // üåÖ –£–¢–†–û
      const morning = {
        id: 'morning',
        title: 'üåÖ –£—Ç—Ä–µ–Ω–Ω—è—è —Ä—É—Ç–∏–Ω–∞',
        subtitle: '–ù–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ –∑—É–±–æ–≤',
        items: [
          { key: 'm1', title: '–í—Å—Ç–∞–ª —Å –∫—Ä–æ–≤–∞—Ç–∏', desc: '–¢—É–∞–ª–µ—Ç ‚Üí —Å—Ä–∞–∑—É –≤ –≤–∞–Ω–Ω—É—é', anchor: '–ù–µ –±—Ä–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω!', next: 'm2' },
          { key: 'm2', title: '–ü–æ—á–∏—Å—Ç–∏–ª –∑—É–±—ã', desc: '–í–∏—Ç–∞–º–∏–Ω—ã + —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã', anchor: '–í–∏—Ç–∞–º–∏–Ω—ã —É —Ä–∞–∫–æ–≤–∏–Ω—ã', next: 'm3' },
          { key: 'm3', title: '–ü—Ä–∏–Ω—è–ª –≤–∏—Ç–∞–º–∏–Ω—ã', desc: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∫—É "—Å–µ–≥–æ–¥–Ω—è —Å–¥–µ–ª–∞—é ___"', anchor: '–ó–∞–ø–∏—Å–∫–∞ –Ω–∞ —Ç—É–º–±–æ—á–∫–µ', next: null },
        ]
      };

      // –î–ª—è 3-–≥–æ/4-–≥–æ –≤ –æ—á–µ—Ä–µ–¥–∏ ‚Äî –±–æ–ª—å—à–æ–µ –æ–∫–Ω–æ
      if (scenario === '3' || scenario === '4') {
        morning.items.push({
          key: 'm_big',
          title: '‚≠ê –ë–æ–ª—å—à–æ–µ –æ–∫–Ω–æ –¥–æ–º–∞!',
          desc: `${scenario === '3' ? '2-3 —á–∞—Å–∞' : '3-4 —á–∞—Å–∞'} –≥–ª—É–±–æ–∫–æ–π —Ä–∞–±–æ—Ç—ã. –ß—Ç–æ –≥–ª–∞–≤–Ω–æ–µ —Å–µ–≥–æ–¥–Ω—è?`,
          anchor: `–ö–æ–Ω—Ç–µ–∫—Å—Ç: ${contextName}`,
          highlight: true
        });
      }

      if (scenario === '4') {
        morning.items.push({
          key: 'm_gym',
          title: 'üèãÔ∏è –ú–æ–∂–Ω–æ –≤ –∑–∞–ª!',
          desc: '–û–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ 15:00 ‚Äî –µ—Å—Ç—å –≤—Ä–µ–º—è –Ω–∞ —Å–ø–æ—Ä—Ç',
          anchor: '–í—Ö–æ–¥ –¥–æ 17:00',
          highlight: true
        });
      }

      sections.push(morning);

      // üö∂ –î–û–†–û–ì–ê (–Ω–µ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö)
      if (scenario !== 'w') {
        sections.push({
          id: 'road',
          title: 'üö∂ –î–æ—Ä–æ–≥–∞ –¥–æ —Ü–µ–Ω—Ç—Ä–∞',
          subtitle: '25 –º–∏–Ω—É—Ç ‚Äî –≤—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º',
          items: [
            { key: 'r1', title: '–í—ã–±—Ä–∞—Ç—å —Ä–µ–∂–∏–º', desc: '–°–ø—Ä–æ—Å–∏—Ç—å —Å–µ–±—è: –∫–∞–∫–æ–π —è —Å–µ–π—á–∞—Å?', anchor: '–°—Ç–∏–∫–µ—Ä –Ω–∞ –¥–≤–µ—Ä–∏', isChoice: true },
            { key: 'r_rest', title: 'üò¥ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï', desc: '–£—Å—Ç–∞–ª ‚Äî YouTube, –ø–æ–¥–∫–∞—Å—Ç, –º—É–∑—ã–∫–∞. –ù–µ —Ç—Ä–æ–≥–∞—Ç—å —Ç–µ–ª–µ–≥—Ä–∞–º.', indent: true },
            { key: 'r_react', title: 'üì® –†–ï–ê–ö–¢–ò–í', desc: '–ï—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ ‚Äî –æ—Ç–≤–µ—á–∞—é. –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã, –Ω–µ –∏–Ω–∏—Ü–∏–∏—Ä—É—é.', indent: true },
            { key: 'r_attack', title: '‚öîÔ∏è –ê–¢–ê–ö–ê', desc: '–≠–Ω–µ—Ä–≥–∏—è –µ—Å—Ç—å ‚Äî –ø–∏—à—É –ø–µ—Ä–≤—ã–º –≤—Ä–∞—á–∞–º, –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º, –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º.', indent: true },
          ]
        });
      }

      // üè• –û–ü–ï–†–ê–¶–ò–û–ù–ù–ê–Ø (–Ω–µ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö)
      if (scenario !== 'w') {
        const hospital = {
          id: 'hospital',
          title: 'üè• –í –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π',
          subtitle: '–û–∫–Ω–∞ –¥–æ –æ–ø–µ—Ä–∞—Ü–∏–∏',
          items: [
            { key: 'h_30', title: '30 –º–∏–Ω –¥–æ –û–ü', desc: '–¢–æ–ª—å–∫–æ —Ä–µ–∞–∫—Ç–∏–≤: —Å—Ä–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–ª–∞–Ω –¥–Ω—è', warn: '–ù–µ –Ω–∞—á–∏–Ω–∞—Ç—å –≥–ª—É–±–æ–∫–æ–µ!' },
            { key: 'h_60', title: '60 –º–∏–Ω –¥–æ –û–ü', desc: '+2-3 –∞—Ç–∞–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤–æ–Ω–æ–∫, –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é', warn: '–ë–µ–∑ –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤' },
            { key: 'h_120', title: '120+ –º–∏–Ω –¥–æ –û–ü', desc: '–ì–ª—É–±–æ–∫–∞—è —Ä–∞–±–æ—Ç–∞: —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —á–µ—Ä–Ω–æ–≤–∏–∫, 5-10 –∞—Ç–∞–∫', warn: '–°–æ–∑–≤–æ–Ω—ã <30 –º–∏–Ω' },
            { key: 'h_end', title: '–í—ã—à–µ–ª –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –û–ü', desc: '–ù–∞–ø–∏—Å–∞—Ç—å –î–∏–∞–Ω–µ "–µ–¥—É"', anchor: '–î–∏–∞–Ω–∞ –∂–¥—ë—Ç', next: 'family' },
          ]
        };

        // –°–ø–æ—Ä—Ç –µ—Å–ª–∏ –û–ü —Ä–∞–Ω–æ
        if (scenario === '3' || scenario === '4') {
          hospital.items.push({
            key: 'h_sport',
            title: '–û–ü –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–æ 15:00?',
            desc: '–û–∫–Ω–æ –¥–ª—è —Å–ø–æ—Ä—Ç–∞! –í—Ö–æ–¥ –≤ –∑–∞–ª –¥–æ 17:00',
            highlight: true
          });
        }

        // –û—Ñ–∏—Å –≤—Ç/—á—Ç
        if (dayOfWeek === 2 || dayOfWeek === 4) {
          hospital.items.push({
            key: 'h_office',
            title: 'üè¢ –ü–æ—Å–ª–µ –û–ü ‚Üí –æ—Ñ–∏—Å',
            desc: dayOfWeek === 2 ? '–í—Ç–æ—Ä–Ω–∏–∫: –ü–æ–ª–µ—á–∞—Ç + –≤—Å—Ç—Ä–µ—á–∏' : '–ß–µ—Ç–≤–µ—Ä–≥: –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∏–ª–∏ –ü–æ–ª–µ—á–∞—Ç',
            highlight: true,
            anchor: '–õ—é–¥–∏ –≤ –æ—Ñ–∏—Å–µ –∂–¥—É—Ç'
          });
        }

        sections.push(hospital);
      }

      // üë®‚Äçüë©‚Äçüëß –°–ï–ú–¨–Ø
      sections.push({
        id: 'family',
        title: 'üë®‚Äçüë©‚Äçüëß –°–µ–º—å—è',
        subtitle: scenario === 'w' ? '–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å' : '–í–µ—á–µ—Ä –¥–æ–º–∞',
        items: scenario === 'w' ? [
          { key: 'f_morning', title: '–£—Ç—Ä–æ —Å —Å–µ–º—å—ë–π', desc: '–ó–∞–≤—Ç—Ä–∞–∫, –≤—Ä–µ–º—è –≤–º–µ—Å—Ç–µ', anchor: '–î–∏–∞–Ω–∞, –ú–∞–π' },
          { key: 'f_walk', title: '~14:00 –ü—Ä–æ–≥—É–ª–∫–∞ —Å –ú–∞–π', desc: '1-2 —á–∞—Å–∞ –Ω–∞ —É–ª–∏—Ü–µ', anchor: '–î–∏–∞–Ω–∞ –∂–¥—ë—Ç –ø–µ—Ä–µ–¥—ã—à–∫—É' },
          { key: 'f_sport', title: '–°–≤–æ–±–æ–¥–Ω–æ–µ –æ–∫–Ω–æ', desc: '–°–ø–æ—Ä—Ç –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏', highlight: true },
        ] : [
          { key: 'f_mai', title: '50 –º–∏–Ω—É—Ç —Å –ú–∞–π', desc: '–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–∏—Ö–æ–¥–∞ –¥–æ–º–æ–π ‚Äî –¥–æ—á—å', anchor: '–î–∏–∞–Ω–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç', next: 'evening' },
          { key: 'f_20', title: '20:00 ‚Äî –±—ã—Ç—å –¥–æ–º–∞', desc: '–ï—Å–ª–∏ –µ—â—ë —Ä–∞–±–æ—Ç–∞—é ‚Äî –∑–∞–∫–æ–Ω—á–∏—Ç—å', warn: '–î–µ–¥–ª–∞–π–Ω!' },
        ]
      });

      // üåô –í–ï–ß–ï–† (—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏)
      if (scenario !== 'w') {
        const evening = {
          id: 'evening',
          title: 'üåô –û–∫–Ω–æ —Å–æ–≤—ã',
          subtitle: `–ö–æ–Ω—Ç–µ–∫—Å—Ç: ${contextName}`,
          items: [
            { key: 'e_start', title: '50 –º–∏–Ω —Å –ú–∞–π –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å', desc: `–û—Ç–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å–∫—É, –∑–∞–¥–∞—á–∞ –ø–æ ${contextName}`, next: 'e_work' },
            { key: 'e_yt', title: '–•–æ—á–µ—Ç—Å—è YouTube?', desc: '–°–Ω–∞—á–∞–ª–∞ –û–î–ù–û –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –∑–∞–¥–∞—á–µ, –ø–æ—Ç–æ–º YouTube', warn: '–ù–µ –Ω–∞–æ–±–æ—Ä–æ—Ç!' },
            { key: 'e_hyper', title: 'üî• –ù–∞–∫—Ä—ã–ª –≥–∏–ø–µ—Ä—Ñ–æ–∫—É—Å', desc: '–ù–µ –º–µ—à–∞—Ç—å —Å–µ–±–µ, –µ—Ö–∞—Ç—å –¥–æ –∫–æ–Ω—Ü–∞. 3-6 —á–∞—Å–æ–≤.', highlight: true },
            { key: 'e_fly', title: '–ü—Ä–∏–ª–µ—Ç–µ–ª–∞ –∑–∞–¥–∞—á–∞', desc: '–ó–∞–ø–∏—Å–∞—Ç—å –≤ "–ø—Ä–∏–ª–µ—Ç–µ–ª–æ", –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–º—É —á—Ç–æ –¥–µ–ª–∞–ª', anchor: 'Brain dump' },
          ]
        };

        // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ ‚Äî –æ—Ç—á—ë—Ç
        if (dayOfWeek === 0) {
          evening.items.push({
            key: 'e_report',
            title: 'üìä 21:00 ‚Äî –û—Ç—á—ë—Ç –∏–Ω–≤–µ—Å—Ç–æ—Ä—É',
            desc: '5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç—ã–¥–Ω–æ!',
            highlight: true,
            anchor: '–ë—É–¥–∏–ª—å–Ω–∏–∫'
          });
          evening.items.push({
            key: 'e_review',
            title: '–ü–æ—Å–ª–µ –æ—Ç—á—ë—Ç–∞',
            desc: '–û–±–∑–æ—Ä —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: –∫–∞–∫–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏? + —Ñ–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏'
          });
        }

        sections.push(evening);
      }

      // üò¥ –°–û–ù
      sections.push({
        id: 'sleep',
        title: 'üò¥ –ü–µ—Ä–µ–¥ —Å–Ω–æ–º',
        subtitle: '–ü–æ—Ä—è–¥–æ–∫: –∑–∞–ø–∏—Å–∫–∞ ‚Üí –∑—É–±—ã ‚Üí –∫—Ä–æ–≤–∞—Ç—å',
        items: [
          { key: 's1', title: '–†–µ—à–∏–ª –ª–æ–∂–∏—Ç—å—Å—è', desc: `–ó–∞–ø–∏—Å–∞—Ç—å: "–∑–∞–≤—Ç—Ä–∞ –ø–æ ${contextName} —Å–¥–µ–ª–∞—é: ___"`, anchor: '–ë–ª–æ–∫–Ω–æ—Ç –Ω–∞ —Ç—É–º–±–æ—á–∫–µ', next: 's2' },
          { key: 's2', title: '–ó–∞–ø–∏—Å–∞–ª', desc: '–¢—É–∞–ª–µ—Ç ‚Üí –∑—É–±—ã', next: 's3' },
          { key: 's3', title: '–ü–æ—á–∏—Å—Ç–∏–ª –∑—É–±—ã', desc: '–õ—ë–≥. –î–µ–Ω—å –∑–∞–∫—Ä—ã—Ç.', final: true },
        ]
      });

      return sections;
    };

    const genId = () => Math.random().toString(36).substr(2, 9);
    const formatDate = (d) => d.toISOString().split('T')[0];

    const LevOS = () => {
      const [tab, setTab] = useState('dash');
      const [dashDate, setDashDate] = useState(() => new Date());
      const [blocks, setBlocks] = useState(() => storage.get('blocks', DEFAULT_BLOCKS));
      const [schedules, setSchedules] = useState(() => storage.get('schedules', {}));
      const [weekContexts, setWeekContexts] = useState(() => storage.get('weekContexts', DEFAULT_WEEK_CONTEXTS));
      const [weekStart, setWeekStart] = useState(() => { const d = new Date(); d.setDate(d.getDate() - d.getDay() + 1); d.setHours(0,0,0,0); return d; });
      const [selectedBlock, setSelectedBlock] = useState(null);
      const [movingBlock, setMovingBlock] = useState(null);
      const [goals, setGoals] = useState(() => storage.get('goals', []));
      const [brainDump, setBrainDump] = useState(() => storage.get('brainDump', []));
      const [checkedTriggers, setCheckedTriggers] = useState(() => storage.get('triggers', {}));
      const [weekFocus, setWeekFocus] = useState(() => storage.get('weekFocus', ''));
      const [metrics, setMetrics] = useState(() => storage.get('metrics', {
        POLECHAT: { contacts: 0, pilots: 0, legal: 0 },
        LAB: { grants: 0, publications: 0, talks: 0 },
        SOMALAB: { revenue: '', b2cProgress: '' },
        PERSONAL: { workouts: 0, maiTime: false }
      }));
      const [showBlockEditor, setShowBlockEditor] = useState(null);
      const [showScenarioModal, setShowScenarioModal] = useState(null);
      const [newGoalText, setNewGoalText] = useState('');
      const [newGoalProject, setNewGoalProject] = useState('');
      const [newGoalPeriod, setNewGoalPeriod] = useState('');
      const [newDumpText, setNewDumpText] = useState('');
      const [newDumpProject, setNewDumpProject] = useState('');
      const [dumpFilter, setDumpFilter] = useState('');
      const [goalsFilter, setGoalsFilter] = useState('');
      const [dayScenarios, setDayScenarios] = useState(() => storage.get('dayScenarios', {}));
      const [currentLocation, setCurrentLocation] = useState(() => storage.get('currentLocation', null));
      const [showLocationPicker, setShowLocationPicker] = useState(false);
      const [almCalc, setAlmCalc] = useState({ arrivedAt: '', myOp: '', currentOp: '' });
      const [showAlmCalc, setShowAlmCalc] = useState(false);
      const [syncStatus, setSyncStatus] = useState('connecting'); // connecting, synced, offline
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);

      // Auth state listener
      useEffect(() => {
        const handleAuthChange = () => {
          setUser(firebaseUser);
          setAuthLoading(false);
          if (!firebaseUser) {
            setSyncStatus('offline');
          }
        };

        window.addEventListener('firebase-auth-changed', handleAuthChange);
        // Check if already signed in
        if (firebaseUser) {
          setUser(firebaseUser);
          setAuthLoading(false);
        } else {
          // Wait a bit for Firebase to init
          setTimeout(() => setAuthLoading(false), 2000);
        }

        return () => window.removeEventListener('firebase-auth-changed', handleAuthChange);
      }, []);

      const handleSignIn = async () => {
        try {
          await signInWithGoogle();
        } catch (error) {
          console.error('Sign in error:', error);
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
        }
      };

      const handleSignOut = async () => {
        if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
          await signOutFirebase();
          setSyncStatus('offline');
        }
      };

      // Refs –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–∫—Ä–æ–ª–ª–∞
      const timeLabelsRef = useRef(null);
      const daysContainerRef = useRef(null);

      // Firebase real-time sync
      useEffect(() => {
        let unsubscribes = [];

        const setupFirebaseSync = () => {
          if (!firebaseReady || !firebaseUserId) return;

          const userRef = database.ref(`users/${firebaseUserId}`);

          // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Firebase
          const syncKeys = [
            { key: 'schedules', setter: setSchedules },
            { key: 'goals', setter: setGoals },
            { key: 'brainDump', setter: setBrainDump },
            { key: 'dayScenarios', setter: setDayScenarios },
            { key: 'metrics', setter: setMetrics },
            { key: 'weekFocus', setter: setWeekFocus },
            { key: 'triggers', setter: setCheckedTriggers },
            { key: 'currentLocation', setter: setCurrentLocation },
            { key: 'weekContexts', setter: setWeekContexts },
          ];

          syncKeys.forEach(({ key, setter }) => {
            const ref = userRef.child(key);
            const unsubscribe = ref.on('value', (snapshot) => {
              const data = snapshot.val();
              if (data !== null) {
                localStorage_.set(key, data);
                setter(data);
              }
              setSyncStatus('synced');
            }, (error) => {
              console.error(`Firebase sync error for ${key}:`, error);
              setSyncStatus('offline');
            });
            unsubscribes.push(() => ref.off('value', unsubscribe));
          });

          // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: –µ—Å–ª–∏ –≤ Firebase –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
          userRef.once('value').then((snapshot) => {
            if (snapshot.exists()) {
              console.log('Loaded data from Firebase');
              setSyncStatus('synced');
            } else {
              // –ï—Å–ª–∏ Firebase –ø—É—Å—Ç–æ–π, –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase
              console.log('Uploading local data to Firebase...');
              const localData = {
                schedules: localStorage_.get('schedules', {}),
                goals: localStorage_.get('goals', []),
                brainDump: localStorage_.get('brainDump', []),
                dayScenarios: localStorage_.get('dayScenarios', {}),
                metrics: localStorage_.get('metrics', {}),
                weekFocus: localStorage_.get('weekFocus', ''),
                triggers: localStorage_.get('triggers', {}),
                currentLocation: localStorage_.get('currentLocation', null),
                weekContexts: localStorage_.get('weekContexts', DEFAULT_WEEK_CONTEXTS),
              };
              userRef.set(localData).then(() => {
                console.log('Local data uploaded to Firebase');
                setSyncStatus('synced');
              });
            }
          });
        };

        if (firebaseReady) {
          setupFirebaseSync();
        } else {
          window.addEventListener('firebase-ready', setupFirebaseSync);
        }

        return () => {
          unsubscribes.forEach(unsub => unsub());
          window.removeEventListener('firebase-ready', setupFirebaseSync);
        };
      }, []);

      useEffect(() => { storage.set('schedules', schedules); }, [schedules]);
      useEffect(() => { storage.set('blocks', blocks); }, [blocks]);
      useEffect(() => { storage.set('weekContexts', weekContexts); }, [weekContexts]);
      useEffect(() => { storage.set('goals', goals); }, [goals]);
      useEffect(() => { storage.set('brainDump', brainDump); }, [brainDump]);
      useEffect(() => { storage.set('triggers', checkedTriggers); }, [checkedTriggers]);
      useEffect(() => { storage.set('weekFocus', weekFocus); }, [weekFocus]);
      useEffect(() => { storage.set('metrics', metrics); }, [metrics]);
      useEffect(() => { storage.set('dayScenarios', dayScenarios); }, [dayScenarios]);
      useEffect(() => { storage.set('currentLocation', currentLocation); }, [currentLocation]);

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ –º–µ–∂–¥—É –º–µ—Ç–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º
      useEffect(() => {
        const timeLabels = timeLabelsRef.current;
        const daysContainer = daysContainerRef.current;
        if (!timeLabels || !daysContainer) return;

        const syncScroll = (e) => {
          timeLabels.scrollTop = e.target.scrollTop;
        };

        daysContainer.addEventListener('scroll', syncScroll);
        return () => daysContainer.removeEventListener('scroll', syncScroll);
      }, [tab]);

      const weekDays = useMemo(() => Array.from({ length: 7 }, (_, i) => {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        return d;
      }), [weekStart]);

      const todayKey = formatDate(new Date());
      const todayDayOfWeek = new Date().getDay();
      const todayContext = weekContexts[todayDayOfWeek];
      const isWeekend = todayDayOfWeek === 0 || todayDayOfWeek === 6;

      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      const detectScenarioFromSchedule = useCallback((schedule) => {
        if (!schedule || schedule.length === 0) return null;
        const opBlock = schedule.find(b => b.blockId && b.blockId.startsWith('OP'));
        if (!opBlock) return isWeekend ? 'w' : null;
        const opStart = opBlock.startHour;
        // 1-–π: –∫ 8:30, 2-–π: –∫ 10:00, 3-–π: –∫ 12:00, 4+: –∫ 15:00
        if (opStart <= 9) return '1';
        if (opStart <= 11) return '2';
        if (opStart <= 13) return '3';
        return '4';
      }, [isWeekend]);

      // –ü–æ–ª—É—á–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –ª—é–±–æ–π –¥–∞—Ç—ã (–∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∏–ª–∏ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
      const getScenarioForDate = useCallback((dateKey) => {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
        if (dayScenarios[dateKey]) {
          return dayScenarios[dateKey];
        }
        // –ò–Ω–∞—á–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        const schedule = schedules[dateKey];
        return detectScenarioFromSchedule(schedule);
      }, [dayScenarios, schedules, detectScenarioFromSchedule]);

      // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–¥–ª—è —Å–µ–≥–æ–¥–Ω—è)
      const activeScenario = useMemo(() => {
        return getScenarioForDate(todayKey);
      }, [todayKey, getScenarioForDate]);

      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –¥–∞—Ç—ã
      const setScenarioForDate = useCallback((dateKey, scenario) => {
        setDayScenarios(prev => ({ ...prev, [dateKey]: scenario }));
      }, []);

      // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      const getCurrentActiveBlock = useCallback(() => {
        const todaySchedule = schedules[todayKey] || [];
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;

        for (const item of todaySchedule) {
          const endHour = item.startHour + item.duration / 60;
          const normalizedStart = item.startHour >= 24 ? item.startHour - 24 : item.startHour;
          const normalizedEnd = endHour >= 24 ? endHour - 24 : endHour;

          if (item.startHour < 24 && currentHour >= item.startHour && currentHour < endHour) {
            return item;
          }
          if (item.startHour >= 24 && currentHour >= normalizedStart && currentHour < normalizedEnd) {
            return item;
          }
        }
        return null;
      }, [schedules, todayKey]);

      // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–∫–∞–∫–æ–π –ø—Ä–æ–µ–∫—Ç —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω)
      const getContextFromSchedule = useMemo(() => {
        const todaySchedule = schedules[todayKey] || [];

        const workBlocks = todaySchedule.filter(b =>
          b.blockId === 'POLECHAT' || b.blockId === 'LAB' || b.blockId === 'SOMALAB'
        );

        if (workBlocks.length === 0) return null;

        const blockToProject = {
          'POLECHAT': 'POLECHAT',
          'LAB': 'LAB',
          'SOMALAB': 'SOMALAB'
        };

        return blockToProject[workBlocks[0].blockId];
      }, [schedules, todayKey]);

      const hasCollision = useCallback((schedule, newStart, newDuration, excludeIds = []) => {
        const newEnd = newStart + newDuration / 60;
        return schedule.some(b => !excludeIds.includes(b.id) && newStart < b.startHour + b.duration / 60 && newEnd > b.startHour);
      }, []);

      const generateAutoBlocks = useCallback((opStart, opDuration) => {
        const opEnd = opStart + opDuration / 60;
        const result = [];
        const ts = Date.now();
        const roadStart = roundToHalfHour(opStart - 0.5);
        if (roadStart >= 7) result.push({ id: `ROAD-${ts}`, blockId: 'ROAD', startHour: roadStart, duration: 25, auto: true });
        result.push({ id: `BUFFER-${ts}`, blockId: 'BUFFER', startHour: roundToHalfHour(opEnd), duration: 30, auto: true });
        const famStart = roundToHalfHour(opEnd + 0.5);
        if (famStart < 22) result.push({ id: `FAM-${ts}`, blockId: 'FAM', startHour: famStart, duration: 50, auto: true });
        return result;
      }, []);

      const recalculateAutoBlocks = useCallback((schedule, opBlock) => {
        const nonAuto = schedule.filter(b => !b.auto);
        return [...nonAuto, ...generateAutoBlocks(opBlock.startHour, opBlock.duration)];
      }, [generateAutoBlocks]);

      // Apply scenario with OP count and context
      const applyScenario = useCallback((dateKey, scenarioKey, opCount, contextKey) => {
        const scenario = SCENARIOS[scenarioKey];
        const context = CONTEXTS[contextKey];
        const schedule = [];
        const ts = Date.now();

        const opBlockId = opCount === 1 ? 'OP_1' : opCount === 2 ? 'OP_2' : 'OP_3';
        const opDuration = blocks[opBlockId].duration;

        if (scenario.isWeekend) {
          schedule.push({ id: `SLEEP-${ts}`, blockId: 'SLEEP', startHour: 27, duration: 480 }); // 03:00 -> 11:00
          schedule.push({ id: `FAM-${ts}`, blockId: 'FAM', startHour: 12, duration: 120 });
          schedule.push({ id: `WALK-${ts}`, blockId: 'WALK', startHour: 14.5, duration: 90 });
          schedule.push({ id: `SPORT-${ts}`, blockId: 'SPORT_SPA', startHour: 16.5, duration: 150 });
          schedule.push({ id: `HYPER-${ts}`, blockId: 'HYPER', startHour: 20, duration: 180 });
        } else {
          // –°–æ–Ω: 8 —á–∞—Å–æ–≤ –¥–æ –ø–æ–¥—ä—ë–º–∞
          const sleepStart = scenario.wakeUp - 8 + 24;
          schedule.push({ id: `SLEEP-${ts}`, blockId: 'SLEEP', startHour: sleepStart, duration: 480 });

          // –î–æ–º–∞—à–Ω–µ–µ –æ–∫–Ω–æ (—Ä–∞–±–æ—Ç–∞ –¥–æ –≤—ã—Ö–æ–¥–∞)
          if (scenario.homeWindow) {
            schedule.push({ id: `HOME-${ts}`, blockId: context.blockId, startHour: scenario.homeWindow.start, duration: scenario.homeWindow.dur });
          }

          // –°–ø–æ—Ä—Ç –¥–ª—è 4-–≥–æ –≤ –æ—á–µ—Ä–µ–¥–∏ (–î–û –æ–ø–µ—Ä–∞—Ü–∏–π, –≤ –æ–∫–Ω–æ –¥–æ–º–∞)
          if (scenario.canGym) {
            schedule.push({ id: `SPORT-${ts}`, blockId: 'SPORT', startHour: 12.5, duration: 90 });
          }

          // –î–æ—Ä–æ–≥–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
          schedule.push({ id: `ROAD-${ts}`, blockId: 'ROAD', startHour: scenario.opStart - 0.5, duration: 25, auto: true });
          schedule.push({ id: `OP-${ts}`, blockId: opBlockId, startHour: scenario.opStart, duration: opDuration });

          const opEnd = scenario.opStart + opDuration / 60;
          schedule.push({ id: `BUFFER-${ts}`, blockId: 'BUFFER', startHour: roundToHalfHour(opEnd), duration: 30, auto: true });
          schedule.push({ id: `ROAD2-${ts}`, blockId: 'ROAD', startHour: roundToHalfHour(opEnd + 0.5), duration: 25, auto: true });

          // –°–µ–º—å—è –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è
          const famStart = roundToHalfHour(opEnd + 1);
          if (famStart < 22) {
            schedule.push({ id: `FAM-${ts}`, blockId: 'FAM', startHour: famStart, duration: 50, auto: true });
          }

          // –í–µ—á–µ—Ä–Ω—è—è —Ä–∞–±–æ—Ç–∞
          const eveStart = roundToHalfHour(famStart + 1);
          if (eveStart < 23) {
            schedule.push({ id: `EVE-${ts}`, blockId: context.blockId, startHour: eveStart, duration: Math.min(180, (24 - eveStart) * 60) });
          }
        }

        setSchedules(prev => ({ ...prev, [dateKey]: schedule }));
        setShowScenarioModal(null);
      }, [blocks]);

      const placeBlock = useCallback((dateKey, hour) => {
        if (!selectedBlock) return;
        const blockDef = blocks[selectedBlock];
        if (!blockDef || (selectedBlock.startsWith('OP') && hour >= 21)) return;
        const schedule = schedules[dateKey] || [];
        if (hasCollision(schedule, hour, blockDef.duration)) return;
        let newSchedule = [...schedule, { id: `${selectedBlock}-${Date.now()}`, blockId: selectedBlock, startHour: hour, duration: blockDef.duration }];
        if (selectedBlock.startsWith('OP')) newSchedule = [...newSchedule, ...generateAutoBlocks(hour, blockDef.duration)];
        setSchedules(prev => ({ ...prev, [dateKey]: newSchedule }));
        setSelectedBlock(null);
      }, [selectedBlock, schedules, blocks, hasCollision, generateAutoBlocks]);

      const moveBlock = useCallback((toDateKey, newHour) => {
        if (!movingBlock) return;
        const { id, dateKey: fromDateKey } = movingBlock;
        const fromSchedule = schedules[fromDateKey] || [];
        const block = fromSchedule.find(b => b.id === id);
        if (!block || (block.blockId.startsWith('OP') && newHour >= 21)) return;
        const toSchedule = fromDateKey === toDateKey ? fromSchedule : (schedules[toDateKey] || []);
        const excludeIds = block.blockId.startsWith('OP') ? [id, ...fromSchedule.filter(b => b.auto).map(b => b.id)] : [id];
        if (hasCollision(toSchedule.filter(b => fromDateKey !== toDateKey || !excludeIds.includes(b.id)), newHour, block.duration)) return;
        let newFromSchedule = fromSchedule.filter(b => b.id !== id);
        if (block.blockId.startsWith('OP')) newFromSchedule = newFromSchedule.filter(b => !b.auto);
        let newToSchedule = fromDateKey === toDateKey ? newFromSchedule : [...toSchedule];
        newToSchedule = [...newToSchedule, { ...block, startHour: newHour }];
        if (block.blockId.startsWith('OP')) newToSchedule = [...newToSchedule, ...generateAutoBlocks(newHour, block.duration)];
        setSchedules(prev => ({ ...prev, [fromDateKey]: newFromSchedule, [toDateKey]: newToSchedule }));
        setMovingBlock(null);
      }, [movingBlock, schedules, hasCollision, generateAutoBlocks]);

      const resizeBlock = useCallback((dateKey, blockId, delta) => {
        const schedule = schedules[dateKey] || [];
        const block = schedule.find(b => b.id === blockId);
        if (!block) return;
        const def = blocks[block.blockId];
        if (!def) return;
        const newDuration = block.duration + delta;
        if (newDuration < def.minDur || newDuration > def.maxDur) return;
        const excludeIds = block.blockId.startsWith('OP') ? [blockId, ...schedule.filter(b => b.auto).map(b => b.id)] : [blockId];
        if (delta > 0 && hasCollision(schedule, block.startHour, newDuration, excludeIds)) return;
        let newSchedule = schedule.map(b => b.id === blockId ? { ...b, duration: newDuration } : b);
        if (block.blockId.startsWith('OP')) newSchedule = recalculateAutoBlocks(newSchedule, { ...block, duration: newDuration });
        setSchedules(prev => ({ ...prev, [dateKey]: newSchedule }));
      }, [schedules, blocks, hasCollision, recalculateAutoBlocks]);

      const removeBlock = useCallback((dateKey, blockId) => {
        const schedule = schedules[dateKey] || [];
        const block = schedule.find(b => b.id === blockId);
        let newSchedule = schedule.filter(b => b.id !== blockId);
        if (block?.blockId.startsWith('OP')) newSchedule = newSchedule.filter(b => !b.auto);
        setSchedules(prev => ({ ...prev, [dateKey]: newSchedule }));
      }, [schedules]);

      const changeWeek = (delta) => setWeekStart(prev => { const d = new Date(prev); d.setDate(d.getDate() + delta * 7); return d; });
      const goToToday = () => { const d = new Date(); d.setDate(d.getDate() - d.getDay() + 1); d.setHours(0,0,0,0); setWeekStart(d); };

      const blocksByCategory = useMemo(() => {
        const result = {};
        Object.values(blocks).forEach(b => {
          if (b.category !== 'BUFFER') {
            if (!result[b.category]) result[b.category] = [];
            result[b.category].push(b);
          }
        });
        return result;
      }, [blocks]);

      const addGoal = () => {
        if (!newGoalText.trim()) return;
        setGoals(prev => [...prev, { id: genId(), text: newGoalText, project: newGoalProject, period: newGoalPeriod, done: false }]);
        setNewGoalText('');
      };
      const toggleGoal = (id) => setGoals(prev => prev.map(g => g.id === id ? { ...g, done: !g.done } : g));
      const deleteGoal = (id) => setGoals(prev => prev.filter(g => g.id !== id));

      const addDump = () => {
        if (!newDumpText.trim()) return;
        setBrainDump(prev => [{ id: genId(), text: newDumpText, project: newDumpProject, createdAt: new Date().toISOString() }, ...prev]);
        setNewDumpText('');
        setNewDumpProject('');
      };
      const deleteDump = (id) => setBrainDump(prev => prev.filter(d => d.id !== id));
      const convertToGoal = (item) => {
        setGoals(prev => [...prev, { id: genId(), text: item.text, project: item.project || '', period: 'D', done: false }]);
        deleteDump(item.id);
      };

      const goalsByPeriod = useMemo(() => {
        const p = { D: [], W: [], M: [], Q: [], other: [] };
        goals.forEach(g => { if (p[g.period]) p[g.period].push(g); else p.other.push(g); });
        return p;
      }, [goals]);

      const updateMetric = (project, field, value) => {
        setMetrics(prev => ({
          ...prev,
          [project]: { ...prev[project], [field]: value }
        }));
      };

      const METRICS_CONFIG = {
        POLECHAT: [
          { key: 'contacts', label: '–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –≤—Ä–∞—á–∞–º–∏', type: 'number', target: 5 },
          { key: 'pilots', label: '–ü–∏–ª–æ—Ç–æ–≤/–ø–ª–∞—Ç—è—â–∏—Ö', type: 'number' },
          { key: 'legal', label: '–Æ—Ä. –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–∫—Ä—ã—Ç–æ', type: 'number' },
        ],
        LAB: [
          { key: 'grants', label: '–ó–∞—è–≤–æ–∫ –Ω–∞ –≥—Ä–∞–Ω—Ç—ã', type: 'number' },
          { key: 'publications', label: '–ü—É–±–ª–∏–∫–∞—Ü–∏–π –≤ —Ä–∞–±–æ—Ç–µ', type: 'number' },
          { key: 'talks', label: '–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π', type: 'number' },
        ],
        SOMALAB: [
          { key: 'revenue', label: '–í—ã—Ä—É—á–∫–∞', type: 'text' },
          { key: 'b2cProgress', label: '–ü—Ä–æ–≥—Ä–µ—Å—Å B2C', type: 'text' },
        ],
        PERSONAL: [
          { key: 'workouts', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', type: 'number', target: 2 },
          { key: 'maiTime', label: '50 –º–∏–Ω —Å –ú–∞–π —Å–µ–≥–æ–¥–Ω—è', type: 'checkbox' },
        ],
      };

      // Day Column
      const DayColumn = ({ date, schedule, dateKey, prevSchedule }) => {
        const dayOfWeek = date.getDay();
        const isToday = dateKey === todayKey;
        const contextKey = weekContexts[dayOfWeek];
        const context = CONTEXTS[contextKey];
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
        const dayScenario = getScenarioForDate(dateKey);
        const scenarioInfo = SCENARIOS[dayScenario];

        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–ª–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–∏–π
        const overflowSleep = useMemo(() => {
          if (!prevSchedule) return null;
          const sleepBlock = prevSchedule.find(b => b.blockId === 'SLEEP');
          if (!sleepBlock) return null;

          if (sleepBlock.startHour >= 24) {
            const sleepDurationHours = sleepBlock.duration / 60;
            const endHour = sleepBlock.startHour - 24 + sleepDurationHours;
            const displayDuration = Math.min(endHour, 12) * 60;

            if (displayDuration > 0) {
              return {
                ...sleepBlock,
                startHour: 0,
                duration: displayDuration,
                isOverflow: true,
                totalDuration: sleepBlock.duration
              };
            }
          }
          return null;
        }, [prevSchedule]);

        return (
          <div className="flex-1 min-w-0 border-r border-gray-800 last:border-r-0 flex flex-col">
            {/* Header */}
            <div
              className={`sticky top-0 z-10 p-0.5 text-center border-b border-gray-700 cursor-pointer ${isToday ? 'bg-orange-900/50' : 'bg-gray-800'}`}
              onClick={() => setShowScenarioModal({ dateKey, dayOfWeek })}
            >
              <div className="flex items-center justify-center gap-1">
                <span className={`font-bold ${isWeekend ? 'text-orange-300' : ''}`} style={{ fontSize: '11px' }}>{dayNames[dayOfWeek]}</span>
                <span className={`${isToday ? 'text-orange-300' : 'text-gray-400'}`} style={{ fontSize: '11px' }}>{date.getDate()}</span>
                {scenarioInfo && (
                  <span className="px-1 bg-orange-600 rounded text-white" style={{ fontSize: '8px' }}>{scenarioInfo.name}</span>
                )}
              </div>
              <div
                className="px-1 py-0.5 rounded mx-0.5"
                style={{ backgroundColor: context.color + '33', color: context.color, fontSize: '9px' }}
              >
                {context.emoji} {context.name}
              </div>
            </div>

            {/* Slots */}
            <div className="relative flex-1" style={{ minHeight: TIME_SLOTS.length * SLOT_HEIGHT }}>
              {TIME_SLOTS.map((slot, idx) => (
                <div key={slot.hour}>
                  {/* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –ø–æ–ª–Ω–æ—á—å */}
                  {slot.hour === 24 && !slot.isHalf && (
                    <div className="absolute left-0 right-0 bg-indigo-600/50 text-center" style={{ top: idx * SLOT_HEIGHT - 1, height: 2 }}></div>
                  )}
                  <div
                    onClick={() => {
                      if (movingBlock) moveBlock(dateKey, slot.hour);
                      else if (selectedBlock) placeBlock(dateKey, slot.hour);
                    }}
                    className={`absolute left-0 right-0 border-b ${slot.isHalf ? 'border-gray-900/50' : 'border-gray-800/50'} ${(selectedBlock || movingBlock) ? 'hover:bg-green-900/30 cursor-pointer' : ''} ${slot.isMidnight ? 'bg-indigo-900/40' : slot.isNight ? 'bg-indigo-950/60' : slot.hour < 7 ? 'bg-gray-900/30' : ''}`}
                    style={{ top: idx * SLOT_HEIGHT, height: SLOT_HEIGHT }}
                  />
                </div>
              ))}

              {/* Overflow —Å–æ–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è */}
              {overflowSleep && (() => {
                const def = blocks[overflowSleep.blockId];
                if (!def) return null;
                const startIdx = TIME_SLOTS.findIndex(s => s.hour === overflowSleep.startHour);
                if (startIdx === -1) return null;
                const top = startIdx * SLOT_HEIGHT;
                const height = (overflowSleep.duration / 30) * SLOT_HEIGHT - 1;
                const totalHours = Math.round(overflowSleep.totalDuration / 60 * 10) / 10;

                return (
                  <div
                    key="overflow-sleep"
                    className="absolute left-0.5 right-0.5 rounded overflow-hidden opacity-70"
                    style={{ top, height, backgroundColor: def.color, borderTop: '2px dashed rgba(255,255,255,0.5)' }}
                  >
                    <div className="p-0.5 text-white h-full flex flex-col" style={{ fontSize: '8px' }}>
                      <div className="flex items-center gap-0.5 truncate">
                        <span>{def.emoji}</span>
                        {height > 16 && <span className="truncate">–°–æ–Ω ({totalHours}—á)</span>}
                      </div>
                    </div>
                  </div>
                );
              })()}

              {schedule.map(item => {
                const def = blocks[item.blockId];
                if (!def) return null;
                const startIdx = TIME_SLOTS.findIndex(s => s.hour === item.startHour);
                if (startIdx === -1) return null;
                const top = startIdx * SLOT_HEIGHT;
                const height = (item.duration / 30) * SLOT_HEIGHT - 1;
                const isMoving = movingBlock?.id === item.id;
                const isSleep = item.blockId === 'SLEEP';
                const sleepHours = isSleep ? Math.round(item.duration / 60 * 10) / 10 : 0;

                return (
                  <div
                    key={item.id}
                    onClick={() => setMovingBlock(isMoving ? null : { id: item.id, dateKey })}
                    className={`absolute left-0.5 right-0.5 rounded overflow-hidden cursor-pointer ${isMoving ? 'ring-2 ring-white z-10' : ''}`}
                    style={{ top, height, backgroundColor: def.color, opacity: item.auto ? 0.6 : 1 }}
                  >
                    <div className="p-0.5 text-white h-full flex flex-col" style={{ fontSize: '8px' }}>
                      <div className="flex items-center gap-0.5 truncate">
                        <span>{def.emoji}</span>
                        {height > 16 && <span className="truncate">{def.name}{isSleep ? ` (${sleepHours}—á)` : ''}</span>}
                      </div>
                      {height >= 32 && (
                        <div className="flex items-center justify-between mt-auto">
                          <span className="opacity-70">{item.duration}–º</span>
                          <div className="flex gap-0.5" onClick={e => e.stopPropagation()}>
                            <button onClick={() => resizeBlock(dateKey, item.id, -30)} disabled={item.duration <= def.minDur} className="w-3.5 h-3.5 bg-white/20 rounded disabled:opacity-30">‚àí</button>
                            <button onClick={() => resizeBlock(dateKey, item.id, 30)} disabled={item.duration >= def.maxDur} className="w-3.5 h-3.5 bg-white/20 rounded disabled:opacity-30">+</button>
                            <button onClick={() => removeBlock(dateKey, item.id)} className="w-3.5 h-3.5 bg-red-500/40 rounded">√ó</button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      // Scenario Modal
      const ScenarioModal = ({ dateKey, dayOfWeek, onClose }) => {
        const savedScenario = getScenarioForDate(dateKey);
        const [scenario, setScenario] = useState(savedScenario || '3');
        const [opCount, setOpCount] = useState(2);
        const [contextKey, setContextKey] = useState(weekContexts[dayOfWeek]);
        const date = new Date(dateKey);

        const handleApply = () => {
          setWeekContexts(prev => ({ ...prev, [dayOfWeek]: contextKey }));
          setScenarioForDate(dateKey, scenario); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π
          applyScenario(dateKey, scenario, opCount, contextKey);
        };

        const handleClear = () => {
          setSchedules(prev => ({ ...prev, [dateKey]: [] }));
          onClose();
        };

        return (
          <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={onClose}>
            <div className="bg-gray-800 rounded-xl p-4 w-full max-w-sm" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg font-bold mb-3 text-center">
                üìÖ {['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'][dayOfWeek]} {date.getDate()}
              </h3>

              <div className="mb-4">
                <div className="text-xs text-gray-400 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–Ω—è:</div>
                <div className="flex gap-1">
                  {Object.entries(CONTEXTS).map(([k, v]) => (
                    <button
                      key={k}
                      onClick={() => setContextKey(k)}
                      className={`flex-1 py-2 rounded text-xs ${contextKey === k ? 'ring-2 ring-white' : ''}`}
                      style={{ backgroundColor: v.color + (contextKey === k ? '' : '44') }}
                    >
                      {v.emoji}
                    </button>
                  ))}
                </div>
              </div>

              <div className="mb-4">
                <div className="text-xs text-gray-400 mb-1">–ù–æ–º–µ—Ä –≤ –æ—á–µ—Ä–µ–¥–∏:</div>
                <div className="flex gap-1">
                  {Object.entries(SCENARIOS).map(([k, s]) => (
                    <button
                      key={k}
                      onClick={() => setScenario(k)}
                      className={`flex-1 py-2 rounded text-xs ${scenario === k ? 'bg-orange-600' : 'bg-gray-700'}`}
                    >
                      <div className="font-bold">{s.name}</div>
                      <div className="text-gray-300" style={{ fontSize: '8px' }}>{s.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {scenario !== 'w' && (
                <div className="mb-4">
                  <div className="text-xs text-gray-400 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π:</div>
                  <div className="flex gap-2">
                    {[1, 2, 3].map(n => (
                      <button
                        key={n}
                        onClick={() => setOpCount(n)}
                        className={`flex-1 py-3 rounded text-lg ${opCount === n ? 'bg-red-600' : 'bg-gray-700'}`}
                      >
                        {'üè•'.repeat(n)}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex gap-2">
                <button onClick={handleClear} className="px-4 py-2 bg-gray-700 rounded text-sm">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button onClick={onClose} className="flex-1 py-2 bg-gray-700 rounded text-sm">–û—Ç–º–µ–Ω–∞</button>
                <button onClick={handleApply} className="flex-1 py-2 bg-green-600 rounded text-sm font-bold">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        );
      };

      // Login screen
      if (authLoading) {
        return (
          <div className="h-screen flex items-center justify-center bg-gray-900 text-white">
            <div className="text-center">
              <div className="text-6xl mb-4">ü¶Å</div>
              <div className="text-xl font-bold mb-2">LEV OS 2.0</div>
              <div className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="h-screen flex items-center justify-center bg-gray-900 text-white p-4">
            <div className="text-center max-w-sm">
              <div className="text-6xl mb-4">ü¶Å</div>
              <div className="text-2xl font-bold mb-2">LEV OS 2.0</div>
              <div className="text-gray-400 mb-6">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</div>

              <button
                onClick={handleSignIn}
                className="w-full flex items-center justify-center gap-3 bg-white text-gray-900 rounded-lg px-4 py-3 font-medium hover:bg-gray-100 transition-colors mb-4"
              >
                <svg className="w-5 h-5" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
              </button>

              <div className="text-xs text-gray-600">
                –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="h-screen flex flex-col bg-gray-900 text-white safe-top">
          {/* Header */}
          <header className="bg-gray-800 border-b border-gray-700 px-2 py-1 shrink-0">
            <div className="flex items-center gap-2">
              <div className="flex items-center gap-1">
                <span className="text-lg">ü¶Å</span>
                {/* Sync status indicator */}
                <span className={`w-2 h-2 rounded-full ${
                  syncStatus === 'synced' ? 'bg-green-500' :
                  syncStatus === 'connecting' ? 'bg-yellow-500 animate-pulse' :
                  'bg-red-500'
                }`} title={syncStatus === 'synced' ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ' : syncStatus === 'connecting' ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' : '–û—Ñ—Ñ–ª–∞–π–Ω'}></span>
              </div>
              <button onClick={() => changeWeek(-1)} className="px-2 text-lg">‚Äπ</button>
              <button onClick={goToToday} className="flex-1 text-center text-sm font-bold">
                {weekStart.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })} ‚Äî {weekDays[6].toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}
              </button>
              <button onClick={() => changeWeek(1)} className="px-2 text-lg">‚Ä∫</button>
              {/* User avatar */}
              {user && (
                <button
                  onClick={handleSignOut}
                  className="w-7 h-7 rounded-full overflow-hidden border-2 border-gray-600 hover:border-orange-500 transition-colors"
                  title={`${user.displayName || user.email}\n–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –≤—ã–π—Ç–∏`}
                >
                  {user.photoURL ? (
                    <img src={user.photoURL} alt="" className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full bg-orange-600 flex items-center justify-center text-xs font-bold">
                      {(user.displayName || user.email || '?')[0].toUpperCase()}
                    </div>
                  )}
                </button>
              )}
            </div>
          </header>

          {/* Tabs */}
          <div className="flex bg-gray-800 border-b border-gray-700 shrink-0">
            {[
              { id: 'dash', label: 'üè†' },
              { id: 'plan', label: 'üìÖ' },
              { id: 'triggers', label: '‚ö°' },
              { id: 'goals', label: 'üéØ' },
              { id: 'dump', label: 'üß†' },
            ].map(t => (
              <button key={t.id} onClick={() => setTab(t.id)} className={`flex-1 py-1.5 text-lg ${tab === t.id ? 'bg-orange-600' : 'text-gray-400'}`}>
                {t.label}
              </button>
            ))}
          </div>

          {/* DASHBOARD TAB */}
          {tab === 'dash' && (() => {
            const dashDateKey = formatDate(dashDate);
            const dashDayOfWeek = dashDate.getDay();
            const dashContext = weekContexts[dashDayOfWeek];
            const dashSchedule = schedules[dashDateKey] || [];
            const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
            const shortDayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

            // –°—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (–∏–∑ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
            const dayScenario = getScenarioForDate(dashDateKey);
            const scenarioInfo = SCENARIOS[dayScenario];

            // –í—Ä–µ–º—è –ø–æ–¥—ä—ë–º–∞ –∏ —Å–Ω–∞ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            const sleepBlock = dashSchedule.find(b => b.blockId === 'SLEEP');
            const wakeUpTime = sleepBlock ? (() => {
              const sleepEnd = sleepBlock.startHour + sleepBlock.duration / 60;
              const normalizedEnd = sleepEnd >= 24 ? sleepEnd - 24 : sleepEnd;
              return `${Math.floor(normalizedEnd)}:${String(Math.round((normalizedEnd % 1) * 60)).padStart(2, '0')}`;
            })() : scenarioInfo?.wakeUp ? `${Math.floor(scenarioInfo.wakeUp)}:${String(Math.round((scenarioInfo.wakeUp % 1) * 60)).padStart(2, '0')}` : '?';

            const sleepStartTime = sleepBlock ? (() => {
              const h = sleepBlock.startHour >= 24 ? sleepBlock.startHour - 24 : sleepBlock.startHour;
              return `${Math.floor(h)}:${String(Math.round((h % 1) * 60)).padStart(2, '0')}`;
            })() : '?';

            // –ù–∞—Ö–æ–¥–∏–º –∫–ª—é—á–µ–≤—ã–µ –±–ª–æ–∫–∏
            const opBlock = dashSchedule.find(b => b.blockId && b.blockId.startsWith('OP'));
            const famBlock = dashSchedule.find(b => b.blockId === 'FAM');
            const sportBlock = dashSchedule.find(b => b.blockId === 'SPORT' || b.blockId === 'SPORT_SPA');
            const workBlocks = dashSchedule.filter(b => ['POLECHAT', 'LAB', 'SOMALAB', 'HYPER'].includes(b.blockId));

            // –í—ã—á–∏—Å–ª—è–µ–º –¥–æ–º–∞—à–Ω–µ–µ –æ–∫–Ω–æ
            const homeWindow = (() => {
              if (!opBlock) return null;
              const roadBlock = dashSchedule.find(b => b.blockId === 'ROAD' && b.startHour < opBlock.startHour);
              if (!roadBlock) return null;
              const wakeUpHour = sleepBlock ? (sleepBlock.startHour + sleepBlock.duration / 60) : (scenarioInfo?.wakeUp || 7);
              const normalizedWakeUp = wakeUpHour >= 24 ? wakeUpHour - 24 : wakeUpHour;
              const windowDuration = Math.round((roadBlock.startHour - normalizedWakeUp) * 60);
              if (windowDuration <= 30) return null;
              return { start: normalizedWakeUp, duration: windowDuration };
            })();

            // –°–æ–∑–¥–∞—ë–º —Å–æ–±—ã—Ç–∏—è —Ç–∞–π–º–ª–∞–π–Ω–∞
            const timelineEvents = [];

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
            const formatHour = (h) => {
              const normalized = h >= 24 ? h - 24 : h;
              return `${Math.floor(normalized)}:${String(Math.round((normalized % 1) * 60)).padStart(2, '0')}`;
            };

            // –ü–æ–¥—ä—ë–º (–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ)
            if (sleepBlock || scenarioInfo?.wakeUp) {
              timelineEvents.push({
                time: wakeUpTime,
                emoji: 'üò¥',
                title: '–ü–æ–¥—ä—ë–º',
                subtitle: '–∑—É–±—ã ‚Üí –≤–∏—Ç–∞–º–∏–Ω—ã',
                color: '#6366F1',
                isVirtual: true
              });
            }

            // –î–æ–º–∞—à–Ω–µ–µ –æ–∫–Ω–æ (–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ)
            if (homeWindow && homeWindow.duration > 30) {
              const hours = Math.floor(homeWindow.duration / 60);
              const mins = homeWindow.duration % 60;
              timelineEvents.push({
                time: formatHour(homeWindow.start + 0.5),
                emoji: 'üî•',
                title: `–û–ö–ù–û ${hours > 0 ? hours + '—á' : ''}${mins > 0 ? ' ' + mins + '–º' : ''}`,
                subtitle: CONTEXTS[dashContext]?.name || '—Ä–∞–±–æ—Ç–∞',
                color: '#F59E0B',
                highlight: true,
                isVirtual: true
              });
            }

            // –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ: –º–æ–∂–Ω–æ –∑–∞–ª (–µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π 4+ –∏ –Ω–µ—Ç —Å–ø–æ—Ä—Ç–∞ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ)
            if (dayScenario === '4' && !sportBlock) {
              timelineEvents.push({
                time: '~15:00',
                emoji: 'üèãÔ∏è',
                title: '–ú–û–ñ–ù–û –ó–ê–õ',
                subtitle: '–≤—Ö–æ–¥ –¥–æ 17:00!',
                color: '#22C55E',
                highlight: true,
                optional: true,
                isVirtual: true
              });
            }

            // –í–°–ï –±–ª–æ–∫–∏ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–∫—Ä–æ–º–µ SLEEP - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
            dashSchedule.filter(b => b.blockId !== 'SLEEP').forEach(b => {
              const blockDef = blocks[b.blockId];
              const startTime = formatHour(b.startHour);

              // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π
              if (b.blockId && b.blockId.startsWith('OP')) {
                timelineEvents.push({
                  time: startTime,
                  emoji: 'üè•',
                  title: '–û–ø–µ—Ä–∞—Ü–∏–∏',
                  subtitle: blockDef?.name || b.blockId,
                  color: '#EF4444',
                  fromCalendar: true
                });
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω–µ—Ü –û–ü
                const opEnd = b.startHour + b.duration / 60;
                timelineEvents.push({
                  time: `~${formatHour(opEnd)}`,
                  emoji: '‚úÖ',
                  title: '–ö–æ–Ω–µ—Ü –û–ü',
                  subtitle: '',
                  color: '#22C55E',
                  isVirtual: true
                });
              }
              // –°–ø–æ—Ä—Ç —Å –ø–æ–º–µ—Ç–∫–æ–π
              else if (b.blockId === 'SPORT' || b.blockId === 'SPORT_SPA') {
                timelineEvents.push({
                  time: startTime,
                  emoji: blockDef?.emoji || 'üèãÔ∏è',
                  title: blockDef?.name || '–°–ø–æ—Ä—Ç',
                  subtitle: '–≤—Ö–æ–¥ –¥–æ 17:00!',
                  color: blockDef?.color || '#22C55E',
                  highlight: true,
                  fromCalendar: true
                });
              }
              // –†–∞–±–æ—á–∏–µ –±–ª–æ–∫–∏
              else if (['POLECHAT', 'LAB', 'SOMALAB', 'HYPER'].includes(b.blockId)) {
                timelineEvents.push({
                  time: startTime,
                  emoji: blockDef?.emoji || 'üíº',
                  title: b.startHour >= 19 ? (b.blockId === 'HYPER' ? '–ì–∏–ø–µ—Ä—Ñ–æ–∫—É—Å' : '–û–∫–Ω–æ —Å–æ–≤—ã') : (blockDef?.name || b.blockId),
                  subtitle: b.startHour >= 19 ? (PROJECTS[b.blockId]?.name || '') : '',
                  color: blockDef?.color || '#F59E0B',
                  fromCalendar: true
                });
              }
              // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
              else {
                timelineEvents.push({
                  time: startTime,
                  emoji: blockDef?.emoji || 'üìå',
                  title: blockDef?.name || b.blockId,
                  subtitle: '',
                  color: blockDef?.color || '#6B7280',
                  fromCalendar: true
                });
              }
            });

            // –ó–∞–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º (–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ)
            if (sleepBlock) {
              timelineEvents.push({
                time: sleepStartTime,
                emoji: 'üìù',
                title: '–ó–∞–ø–∏—Å–∫–∞',
                subtitle: '‚Üí –∑—É–±—ã ‚Üí —Å–æ–Ω',
                color: '#6366F1',
                isVirtual: true
              });
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            timelineEvents.sort((a, b) => {
              const parseTime = (t) => {
                const clean = t.replace('~', '');
                const [h, m] = clean.split(':').map(Number);
                return h + m / 60;
              };
              return parseTime(a.time) - parseTime(b.time);
            });

            // –¶–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å
            const dayGoals = goals.filter(g => g.period === 'D' && !g.done && (!g.project || g.project === dashContext));
            const weekGoal = goals.find(g => g.period === 'W' && !g.done);

            const changeDashDay = (delta) => {
              const newDate = new Date(dashDate);
              newDate.setDate(newDate.getDate() + delta);
              setDashDate(newDate);
            };

            const goToDashToday = () => setDashDate(new Date());
            const isToday = dashDateKey === todayKey;

            return (
              <div className="flex-1 overflow-auto safe-bottom">
                {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º */}
                <div className="bg-gray-800 border-b border-gray-700 px-3 py-2">
                  <div className="flex items-center justify-between">
                    <button onClick={() => changeDashDay(-1)} className="px-3 py-1 text-xl">‚Äπ</button>
                    <button onClick={goToDashToday} className="flex-1 text-center">
                      <div className={`text-lg font-bold ${isToday ? 'text-orange-400' : ''}`}>
                        {dayNames[dashDayOfWeek]}
                      </div>
                      <div className="text-sm text-gray-400">
                        {dashDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}
                        {isToday && <span className="text-orange-400 ml-2">—Å–µ–≥–æ–¥–Ω—è</span>}
                      </div>
                    </button>
                    <button onClick={() => changeDashDay(1)} className="px-3 py-1 text-xl">‚Ä∫</button>
                  </div>
                </div>

                <div className="p-3 space-y-3">
                  {/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è */}
                  <div className="bg-gray-800 rounded-xl p-3">
                    <div className="flex items-start justify-between mb-2">
                      <div>
                        <div className="text-2xl font-bold flex items-center gap-2">
                          {dayScenario ? (
                            <>
                              {scenarioInfo?.name}
                              <span className="text-sm font-normal text-gray-400">–≤ –æ—á–µ—Ä–µ–¥–∏</span>
                            </>
                          ) : (
                            <span className="text-gray-500">–í—ã–±–µ—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π</span>
                          )}
                        </div>
                        {scenarioInfo && (
                          <div className="text-sm text-gray-400">{scenarioInfo.desc}</div>
                        )}
                      </div>
                      <div className="text-right">
                        <div className="px-2 py-1 rounded-lg" style={{ backgroundColor: CONTEXTS[dashContext]?.color + '33', color: CONTEXTS[dashContext]?.color }}>
                          {CONTEXTS[dashContext]?.emoji} {CONTEXTS[dashContext]?.name}
                        </div>
                      </div>
                    </div>

                    {/* –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è */}
                    <div className="flex gap-1 mb-3">
                      {Object.entries(SCENARIOS).map(([k, s]) => (
                        <button
                          key={k}
                          onClick={() => setScenarioForDate(dashDateKey, k)}
                          className={`flex-1 py-1.5 rounded text-xs transition-all ${dayScenario === k ? 'bg-orange-600 ring-2 ring-orange-400' : 'bg-gray-700 hover:bg-gray-600'}`}
                        >
                          <div className="font-bold">{s.name}</div>
                          <div className="text-gray-300" style={{ fontSize: '8px' }}>{s.desc}</div>
                        </button>
                      ))}
                    </div>

                    {/* –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–Ω—è */}
                    <div className="grid grid-cols-2 gap-2">
                      <div className="bg-gray-900 rounded-lg p-2 text-center">
                        <div className="text-xs text-gray-500">–ü–æ–¥—ä—ë–º</div>
                        <div className="text-xl font-bold text-indigo-400">{wakeUpTime}</div>
                      </div>
                      <div className="bg-gray-900 rounded-lg p-2 text-center">
                        <div className="text-xs text-gray-500">–°–æ–Ω</div>
                        <div className="text-xl font-bold text-indigo-400">{sleepStartTime}</div>
                      </div>
                    </div>

                    {/* –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã */}
                    <div className="flex flex-wrap gap-2 mt-3">
                      {dayScenario === '3' && (
                        <div className="px-2 py-1 bg-red-900/30 text-red-300 rounded-lg text-sm">
                          ‚ö†Ô∏è –ü–æ–∑–≤–æ–Ω–∏—Ç—å! –ú–æ–∂–µ—Ç –±—ã—Ç—å 15:00
                        </div>
                      )}
                      {homeWindow && (
                        <div className="px-2 py-1 bg-yellow-900/30 text-yellow-300 rounded-lg text-sm">
                          üè† –û–∫–Ω–æ: {Math.floor(homeWindow.duration / 60)}-{Math.ceil(homeWindow.duration / 60)} —á–∞—Å–∞
                        </div>
                      )}
                      {(sportBlock || dayScenario === '4') && (
                        <div className="px-2 py-1 bg-green-900/30 text-green-300 rounded-lg text-sm">
                          üèãÔ∏è –ú–æ–∂–Ω–æ –≤ –∑–∞–ª
                        </div>
                      )}
                      {dashDayOfWeek === 2 && (
                        <div className="px-2 py-1 bg-blue-900/30 text-blue-300 rounded-lg text-sm">
                          üè¢ –û—Ñ–∏—Å –ü–æ–ª–µ—á–∞—Ç
                        </div>
                      )}
                      {dashDayOfWeek === 4 && (
                        <div className="px-2 py-1 bg-purple-900/30 text-purple-300 rounded-lg text-sm">
                          üè¢ –û—Ñ–∏—Å –õ–∞–±
                        </div>
                      )}
                      {dashDayOfWeek === 0 && (
                        <div className="px-2 py-1 bg-orange-900/30 text-orange-300 rounded-lg text-sm">
                          üìä 21:00 –û—Ç—á—ë—Ç
                        </div>
                      )}
                    </div>
                  </div>

                  {/* –¢–∞–π–º–ª–∞–π–Ω –¥–Ω—è */}
                  <div className="bg-gray-800 rounded-xl p-3">
                    <div className="text-sm font-bold mb-3 text-gray-400">–¢–∞–π–º–ª–∞–π–Ω –¥–Ω—è</div>

                    {timelineEvents.length > 0 ? (
                      <div className="relative">
                        {/* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è */}
                        <div className="absolute left-[52px] top-2 bottom-2 w-0.5 bg-gray-700"></div>

                        <div className="space-y-3">
                          {timelineEvents.map((event, idx) => (
                            <div key={idx} className={`flex items-start gap-3 ${event.optional ? 'opacity-60' : ''}`}>
                              {/* –í—Ä–µ–º—è */}
                              <div className="w-12 text-right text-sm text-gray-500 pt-1 shrink-0">
                                {event.time}
                              </div>

                              {/* –¢–æ—á–∫–∞ –Ω–∞ –ª–∏–Ω–∏–∏ */}
                              <div
                                className={`w-5 h-5 rounded-full flex items-center justify-center text-xs shrink-0 z-10 ${event.highlight ? 'ring-2 ring-offset-2 ring-offset-gray-800' : ''}`}
                                style={{ backgroundColor: event.color, ringColor: event.color }}
                              >
                                {event.emoji}
                              </div>

                              {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
                              <div className="flex-1 min-w-0">
                                <div className={`font-medium ${event.highlight ? 'text-yellow-300' : ''}`}>
                                  {event.title}
                                </div>
                                {event.subtitle && (
                                  <div className="text-xs text-gray-500">{event.subtitle}</div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ) : (
                      <div className="text-center text-gray-600 py-4">
                        <div className="text-3xl mb-2">üìÖ</div>
                        <div>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div>
                        <button
                          onClick={() => { setTab('plan'); }}
                          className="mt-2 px-3 py-1 bg-orange-600 rounded text-sm"
                        >
                          –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω
                        </button>
                      </div>
                    )}
                  </div>

                  {/* –¶–µ–ª–∏ */}
                  {(dayGoals.length > 0 || weekGoal || weekFocus) && (
                    <div className="bg-gray-800 rounded-xl p-3">
                      <div className="text-sm font-bold mb-2 text-gray-400">üéØ –¶–µ–ª–∏</div>

                      {weekFocus && (
                        <div className="bg-orange-900/20 border border-orange-800 rounded-lg p-2 mb-2">
                          <div className="text-xs text-orange-400 mb-0.5">–§–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏</div>
                          <div className="text-sm">{weekFocus}</div>
                        </div>
                      )}

                      {weekGoal && (
                        <div className="flex items-center gap-2 bg-gray-900 rounded-lg p-2 mb-1">
                          <span className="text-xs text-gray-500">üìÜ</span>
                          <span className="text-sm flex-1">{weekGoal.text}</span>
                        </div>
                      )}

                      {dayGoals.map(g => (
                        <div key={g.id} onClick={() => toggleGoal(g.id)} className="flex items-center gap-2 bg-gray-900 rounded-lg p-2 mb-1 cursor-pointer">
                          <div className="w-4 h-4 rounded border border-gray-600"></div>
                          <span className="text-sm flex-1">{g.text}</span>
                          {g.project && (
                            <span className="text-xs px-1 rounded" style={{ backgroundColor: PROJECTS[g.project]?.color + '44' }}>
                              {PROJECTS[g.project]?.emoji}
                            </span>
                          )}
                        </div>
                      ))}
                    </div>
                  )}

                  {/* –ö–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –≥–¥–µ —Ç—ã —Å–µ–π—á–∞—Å */}
                  <div className="bg-gray-800 rounded-xl p-3">
                    <div className="text-sm font-bold mb-2 text-gray-400">üìç –ì–¥–µ —Ç—ã —Å–µ–π—á–∞—Å?</div>

                    {!showLocationPicker ? (
                      <button
                        onClick={() => setShowLocationPicker(true)}
                        className="w-full p-3 rounded-lg border-2 border-dashed border-gray-600 hover:border-gray-500 transition-colors"
                      >
                        {currentLocation ? (
                          <div className="flex items-center gap-3">
                            <div className="text-2xl">{LOCATION_CONTEXTS[currentLocation]?.emoji}</div>
                            <div className="text-left flex-1">
                              <div className="font-medium">{LOCATION_CONTEXTS[currentLocation]?.name}</div>
                              <div className="text-xs text-gray-400">{LOCATION_CONTEXTS[currentLocation]?.works}</div>
                            </div>
                            <div className="text-gray-500">‚úèÔ∏è</div>
                          </div>
                        ) : (
                          <div className="text-gray-500">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
                        )}
                      </button>
                    ) : (
                      <div className="space-y-2">
                        <div className="grid grid-cols-3 gap-2">
                          {Object.values(LOCATION_CONTEXTS).map(loc => (
                            <button
                              key={loc.id}
                              onClick={() => { setCurrentLocation(loc.id); setShowLocationPicker(false); }}
                              className={`p-2 rounded-lg text-center transition-all ${currentLocation === loc.id ? 'ring-2 ring-orange-500' : 'hover:bg-gray-700'}`}
                              style={{ backgroundColor: loc.color + '22' }}
                            >
                              <div className="text-xl">{loc.emoji}</div>
                              <div className="text-xs truncate">{loc.name.split(' ')[0]}</div>
                            </button>
                          ))}
                        </div>
                        <button
                          onClick={() => setShowLocationPicker(false)}
                          className="w-full py-1 text-sm text-gray-500"
                        >
                          –û—Ç–º–µ–Ω–∞
                        </button>
                      </div>
                    )}

                    {/* –î–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ */}
                    {currentLocation && !showLocationPicker && (() => {
                      const loc = LOCATION_CONTEXTS[currentLocation];
                      const projectTasks = Object.entries(loc.tasks || {});
                      return (
                        <div className="mt-3 space-y-2">
                          {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ */}
                          {loc.warning && (
                            <div className="bg-red-900/30 border border-red-800 rounded-lg p-2 text-sm text-red-300">
                              ‚ö†Ô∏è {loc.warning}
                            </div>
                          )}

                          {/* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ */}
                          <div className="grid grid-cols-2 gap-2 text-xs">
                            <div className="bg-gray-900 rounded p-2">
                              <span className="text-gray-500">–í—Ä–µ–º—è:</span> {loc.time}
                            </div>
                            <div className="bg-gray-900 rounded p-2">
                              <span className="text-gray-500">–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:</span> {loc.interrupt}
                            </div>
                            <div className="bg-gray-900 rounded p-2">
                              <span className="text-gray-500">–≠–Ω–µ—Ä–≥–∏—è:</span> {loc.energy}
                            </div>
                            <div className="bg-gray-900 rounded p-2">
                              <span className="text-gray-500">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</span> {loc.tools}
                            </div>
                          </div>

                          {/* –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç */}
                          <div className="bg-gray-900 rounded-lg p-2">
                            <div className="text-xs text-gray-500 mb-1">–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</div>
                            <div className="text-sm">{loc.works}</div>
                          </div>

                          {/* Temptation bundle */}
                          {loc.bundle && (
                            <div className="bg-yellow-900/20 border border-yellow-800 rounded-lg p-2">
                              <div className="text-xs text-yellow-500 mb-1">üéÅ –°–≤—è–∑–∫–∞:</div>
                              <div className="text-sm text-yellow-200">{loc.bundle}</div>
                            </div>
                          )}

                          {/* –ó–∞–¥–∞—á–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º */}
                          {projectTasks.length > 0 && (
                            <div className="space-y-1">
                              <div className="text-xs text-gray-500">–ü–æ –ø—Ä–æ–µ–∫—Ç–∞–º:</div>
                              {projectTasks.map(([proj, task]) => (
                                <div key={proj} className="flex items-center gap-2 bg-gray-900 rounded p-2">
                                  <span style={{ color: PROJECTS[proj]?.color }}>{PROJECTS[proj]?.emoji}</span>
                                  <span className="text-xs text-gray-400">{PROJECTS[proj]?.name}:</span>
                                  <span className="text-sm flex-1">{task}</span>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>

                  {/* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ê–ª–º–∞–∑–æ–≤–∞ */}
                  <div className="bg-gray-800 rounded-xl overflow-hidden">
                    <button
                      onClick={() => setShowAlmCalc(!showAlmCalc)}
                      className="w-full p-3 flex items-center justify-between hover:bg-gray-700/50 transition-colors"
                    >
                      <div className="flex items-center gap-2">
                        <span className="text-xl">üè•</span>
                        <span className="font-medium">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–∂–∏–¥–∞–Ω–∏—è</span>
                      </div>
                      <span className="text-gray-500 text-xs">{showAlmCalc ? '‚ñº —Å–≤–µ—Ä–Ω—É—Ç—å' : '‚ñ∂ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å'}</span>
                    </button>

                    {showAlmCalc && (
                      <div className="px-3 pb-3 space-y-3">
                        {/* –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –Ω–æ–º–µ—Ä–æ–≤ */}
                        <div className="bg-gray-900 rounded-lg p-3">
                          <div className="flex items-center gap-4 justify-center">
                            <div className="text-center">
                              <div className="text-xs text-gray-500 mb-1">–°–µ–π—á–∞—Å –∏–¥—ë—Ç</div>
                              <div className="flex items-center gap-1">
                                <button
                                  onClick={() => setAlmCalc({...almCalc, currentOp: Math.max(1, (parseInt(almCalc.currentOp) || 1) - 1).toString()})}
                                  className="w-8 h-8 bg-gray-800 rounded-lg hover:bg-gray-700"
                                >‚àí</button>
                                <div className="w-12 h-12 bg-red-900/50 border-2 border-red-600 rounded-xl flex items-center justify-center text-2xl font-bold text-red-300">
                                  {almCalc.currentOp || '?'}
                                </div>
                                <button
                                  onClick={() => setAlmCalc({...almCalc, currentOp: Math.min(10, (parseInt(almCalc.currentOp) || 0) + 1).toString()})}
                                  className="w-8 h-8 bg-gray-800 rounded-lg hover:bg-gray-700"
                                >+</button>
                              </div>
                            </div>

                            <div className="text-2xl text-gray-600">‚Üí</div>

                            <div className="text-center">
                              <div className="text-xs text-gray-500 mb-1">–Ø –≤ –æ—á–µ—Ä–µ–¥–∏</div>
                              <div className="flex items-center gap-1">
                                <button
                                  onClick={() => setAlmCalc({...almCalc, myOp: Math.max(1, (parseInt(almCalc.myOp) || 1) - 1).toString()})}
                                  className="w-8 h-8 bg-gray-800 rounded-lg hover:bg-gray-700"
                                >‚àí</button>
                                <div className="w-12 h-12 bg-orange-900/50 border-2 border-orange-500 rounded-xl flex items-center justify-center text-2xl font-bold text-orange-300">
                                  {almCalc.myOp || '?'}
                                </div>
                                <button
                                  onClick={() => setAlmCalc({...almCalc, myOp: Math.min(10, (parseInt(almCalc.myOp) || 0) + 1).toString()})}
                                  className="w-8 h-8 bg-gray-800 rounded-lg hover:bg-gray-700"
                                >+</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Result */}
                        {almCalc.myOp && almCalc.currentOp && (() => {
                          const myOp = parseInt(almCalc.myOp);
                          const currentOp = parseInt(almCalc.currentOp);

                          // –°–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –Ω—É–∂–Ω–æ –¥–æ–∂–¥–∞—Ç—å—Å—è
                          // –ï—Å–ª–∏ –∏–¥—ë—Ç 1-—è, –∞ —è 3-–π: –∂–¥—É –∫–æ–Ω–µ—Ü 1-–π + –≤—Å—é 2-—é = ~1.5 –æ–ø–µ—Ä–∞—Ü–∏–∏
                          const opsToWait = myOp - currentOp;

                          if (opsToWait <= 0) {
                            return (
                              <div className="bg-gradient-to-r from-green-900/50 to-emerald-900/50 border border-green-600 rounded-xl p-4 text-center">
                                <div className="text-4xl mb-2">üö®</div>
                                <div className="text-xl font-bold text-green-300">–¢–≤–æ—è –æ—á–µ—Ä–µ–¥—å!</div>
                                <div className="text-sm text-green-400 mt-1">–ì–æ—Ç–æ–≤—å—Å—è –∫ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
                              </div>
                            );
                          }

                          // –†–µ–∞–ª—å–Ω—ã–µ —Ç–∞–π–º–∏–Ω–≥–∏:
                          // - —Ç–µ–∫—É—â–∞—è –û–ü —É–∂–µ –∏–¥—ë—Ç, –æ—Å—Ç–∞–ª–æ—Å—å ~30-60 –º–∏–Ω
                          // - –∫–∞–∂–¥–∞—è —Å–ª–µ–¥—É—é—â–∞—è ~60-120 –º–∏–Ω
                          const currentOpRemaining = { min: 30, max: 60 }; // –æ—Å—Ç–∞—Ç–æ–∫ —Ç–µ–∫—É—â–µ–π
                          const perOp = { min: 60, max: 120 }; // –Ω–∞ –∫–∞–∂–¥—É—é –ø–æ–ª–Ω—É—é –û–ü

                          const fullOpsToWait = Math.max(0, opsToWait - 1);
                          const minWait = currentOpRemaining.min + fullOpsToWait * perOp.min;
                          const maxWait = currentOpRemaining.max + fullOpsToWait * perOp.max;
                          const avgWait = Math.round((minWait + maxWait) / 2);

                          const formatDuration = (mins) => {
                            if (mins < 60) return `${mins} –º–∏–Ω`;
                            const h = Math.floor(mins / 60);
                            const m = mins % 60;
                            if (m === 0) return `${h} —á`;
                            return `${h} —á ${m} –º–∏–Ω`;
                          };

                          // –í–∏–∑—É–∞–ª—å–Ω–∞—è —à–∫–∞–ª–∞ –æ—á–µ—Ä–µ–¥–∏
                          const queueVisual = [];
                          for (let i = 1; i <= Math.max(myOp, 5); i++) {
                            queueVisual.push(
                              <div
                                key={i}
                                className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold transition-all ${
                                  i < currentOp ? 'bg-gray-700 text-gray-500' :
                                  i === currentOp ? 'bg-red-600 text-white animate-pulse' :
                                  i === myOp ? 'bg-orange-500 text-white ring-2 ring-orange-300' :
                                  i < myOp ? 'bg-gray-600 text-gray-300' :
                                  'bg-gray-800 text-gray-600'
                                }`}
                              >
                                {i}
                              </div>
                            );
                          }

                          // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
                          let tasks = [];
                          let intensity = '';
                          let intensityLabel = '';

                          if (opsToWait === 1) {
                            // –°–ª–µ–¥—É—é—â–∏–π = —è, –æ—Å—Ç–∞–ª–æ—Å—å 30-60 –º–∏–Ω
                            intensity = 'urgent';
                            intensityLabel = '–°–∫–æ—Ä–æ –≤—ã–∑–æ–≤—É—Ç!';
                            tasks = ['–¢–µ–ª–µ—Ñ–æ–Ω –≤ —Ä—É–∫–µ', '–ù–∏–∫–∞–∫–∏—Ö –∑–∞–¥–∞—á', '–ë—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º'];
                          } else if (avgWait <= 75) {
                            // ~1—á –æ–∫–Ω–æ
                            intensity = 'low';
                            intensityLabel = '–ú–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏';
                            tasks = ['–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ —á–∞—Ç–∞—Ö', '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—á—Ç—É', '–ù–µ —É–≥–ª—É–±–ª—è—Ç—å—Å—è'];
                          } else if (avgWait <= 150) {
                            // ~1.5-2—á –æ–∫–Ω–æ
                            intensity = 'medium';
                            intensityLabel = '–ï—Å—Ç—å –æ–∫–Ω–æ';
                            tasks = ['Inbox zero', '–ú–µ–ª–∫–∏–µ –∑–∞–¥–∞—á–∏', '–ß—Ç–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π', '–ì–æ–ª–æ—Å–æ–≤—ã–µ'];
                          } else {
                            // 2.5—á+ –æ–∫–Ω–æ
                            intensity = 'high';
                            intensityLabel = '–ë–æ–ª—å—à–æ–µ –æ–∫–Ω–æ';
                            tasks = ['–ú–æ–∂–Ω–æ –Ω–æ—É—Ç–±—É–∫', '–†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏', '–î–æ–∫—É–º–µ–Ω—Ç—ã', '–ù–ï –≥–ª—É–±–æ–∫–∞—è —Ä–∞–±–æ—Ç–∞!'];
                          }

                          return (
                            <div className="space-y-3">
                              {/* –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å */}
                              <div className="flex items-center justify-center gap-1 py-2">
                                {queueVisual}
                              </div>

                              {/* –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */}
                              <div className={`rounded-xl p-4 ${
                                intensity === 'urgent' ? 'bg-gradient-to-r from-red-900/50 to-orange-900/50 border border-red-600' :
                                intensity === 'low' ? 'bg-gradient-to-r from-yellow-900/40 to-orange-900/40 border border-yellow-700' :
                                intensity === 'medium' ? 'bg-gradient-to-r from-blue-900/40 to-cyan-900/40 border border-blue-700' :
                                'bg-gradient-to-r from-green-900/40 to-teal-900/40 border border-green-700'
                              }`}>
                                <div className="flex items-center justify-between mb-3">
                                  <div>
                                    <div className="text-xs text-gray-400">–î–æ —Ç–µ–±—è</div>
                                    <div className="text-3xl font-bold">{opsToWait} {opsToWait === 1 ? '–æ–ø–µ—Ä–∞—Ü–∏—è' : opsToWait < 5 ? '–æ–ø–µ—Ä–∞—Ü–∏–∏' : '–æ–ø–µ—Ä–∞—Ü–∏–π'}</div>
                                  </div>
                                  <div className="text-right">
                                    <div className="text-xs text-gray-400">–û–∂–∏–¥–∞–Ω–∏–µ</div>
                                    <div className="text-lg font-medium">~{formatDuration(avgWait)}</div>
                                    <div className="text-xs text-gray-500">{formatDuration(minWait)} ‚Äì {formatDuration(maxWait)}</div>
                                  </div>
                                </div>

                                <div className={`inline-block px-2 py-1 rounded-full text-xs font-medium ${
                                  intensity === 'urgent' ? 'bg-red-600 text-white' :
                                  intensity === 'low' ? 'bg-yellow-600 text-white' :
                                  intensity === 'medium' ? 'bg-blue-600 text-white' :
                                  'bg-green-600 text-white'
                                }`}>
                                  {intensityLabel}
                                </div>
                              </div>

                              {/* –ß—Ç–æ –¥–µ–ª–∞—Ç—å */}
                              <div className="bg-gray-900 rounded-lg p-3">
                                <div className="text-xs text-gray-500 mb-2">–ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å:</div>
                                <div className="flex flex-wrap gap-2">
                                  {tasks.map((task, i) => (
                                    <span key={i} className={`px-2 py-1 rounded text-xs ${
                                      task.includes('–ù–ï') || task.includes('–ù–∏–∫–∞–∫–∏—Ö')
                                        ? 'bg-red-900/50 text-red-300'
                                        : 'bg-gray-800 text-gray-300'
                                    }`}>
                                      {task}
                                    </span>
                                  ))}
                                </div>
                              </div>

                              {/* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ */}
                              {intensity !== 'urgent' && (
                                <div className="flex items-center gap-2 text-xs text-gray-500">
                                  <span>‚ö†Ô∏è</span>
                                  <span>–ú–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å —Ä–∞–Ω—å—à–µ ‚Äî –¥–µ—Ä–∂–∏ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä—è–¥–æ–º</span>
                                </div>
                              )}
                            </div>
                          );
                        })()}

                        {/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ */}
                        {(!almCalc.myOp || !almCalc.currentOp) && (
                          <div className="text-center text-sm text-gray-500 py-2">
                            –£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –≤—ã—à–µ
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  {/* –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ */}
                  <div className="bg-gray-800/50 rounded-xl p-3 text-center">
                    <div className="text-sm text-gray-500 italic">
                      "–ü–æ–∫–∞–∑–∞–ª –∑–∞–¥–∞—á—É, –æ—Ç–æ—à—ë–ª. –ó–∞—Ö–≤–∞—Ç–∏–ª–æ ‚Äî –µ–¥—É."
                    </div>
                  </div>
                </div>
              </div>
            );
          })()}

          {/* PLAN TAB */}
          {tab === 'plan' && (
            <div className="flex-1 flex flex-col overflow-hidden">
              {/* Selection indicator */}
              {(selectedBlock || movingBlock) && (
                <div className={`px-2 py-0.5 text-center text-xs shrink-0 ${movingBlock ? 'bg-blue-800' : 'bg-green-800'}`}>
                  {movingBlock ? '‚ÜïÔ∏è –¢–∞–ø–Ω–∏ –∫—É–¥–∞' : `${blocks[selectedBlock]?.emoji} –¢–∞–ø–Ω–∏ –Ω–∞ —Å–ª–æ—Ç`}
                </div>
              )}

              {/* Week view */}
              <div className="flex-1 flex overflow-hidden">
                {/* Time labels - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—ë–º */}
                <div ref={timeLabelsRef} className="w-5 shrink-0 bg-gray-900 overflow-hidden no-scrollbar" style={{ paddingTop: '52px' }}>
                  {TIME_SLOTS.map((slot) => (
                    <div key={slot.hour} className={`flex items-center justify-end pr-0.5 ${
                      slot.isMidnight ? 'text-indigo-400 font-bold' :
                      slot.isNight ? 'text-indigo-400' :
                      slot.hour < 7 ? 'text-gray-600' :
                      slot.isHalf ? 'text-gray-800' : 'text-gray-500'
                    }`} style={{ height: SLOT_HEIGHT, fontSize: '7px' }}>
                      {!slot.isHalf && slot.label}
                    </div>
                  ))}
                </div>

                {/* Days */}
                <div ref={daysContainerRef} className="flex-1 flex overflow-x-auto overflow-y-auto timeline-scroll">
                  {weekDays.map((day, idx) => {
                    const dk = formatDate(day);
                    const prevDay = new Date(day);
                    prevDay.setDate(prevDay.getDate() - 1);
                    const prevDk = formatDate(prevDay);
                    return <DayColumn key={dk} date={day} dateKey={dk} schedule={schedules[dk] || []} prevSchedule={schedules[prevDk] || []} />;
                  })}
                </div>
              </div>

              {/* Block library - bottom */}
              <div className="bg-gray-800 border-t border-gray-700 p-2 shrink-0 max-h-36 overflow-y-auto">
                <div className="space-y-1.5">
                  {Object.entries(blocksByCategory).map(([cat, catBlocks]) => (
                    <div key={cat}>
                      <div className="text-gray-500 mb-0.5" style={{ fontSize: '9px' }}>{CATEGORIES[cat]?.name}</div>
                      <div className="flex flex-wrap gap-1">
                        {catBlocks.map(b => (
                          <button
                            key={b.id}
                            onClick={() => setSelectedBlock(selectedBlock === b.id ? null : b.id)}
                            onContextMenu={(e) => { e.preventDefault(); setShowBlockEditor(b); }}
                            className={`flex items-center gap-1 px-1.5 py-1 rounded ${selectedBlock === b.id ? 'ring-2 ring-white' : ''}`}
                            style={{ background: selectedBlock === b.id ? b.color : `${b.color}33`, borderLeft: `3px solid ${b.color}`, fontSize: '10px' }}
                          >
                            <span>{b.emoji}</span>
                            <span className="text-white">{b.name}</span>
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* TRIGGERS TAB */}
          {tab === 'triggers' && (() => {
            const triggers = getTriggers(activeScenario, todayDayOfWeek, todayContext);
            const contextProject = getContextFromSchedule || (todayContext === 'POLECHAT' ? 'POLECHAT' : todayContext === 'LAB' ? 'LAB' : todayContext === 'SOMALAB' ? 'SOMALAB' : null);
            const contextDump = contextProject ? brainDump.filter(d => d.project === contextProject) : [];
            const contextGoals = contextProject ? goals.filter(g => g.project === contextProject && !g.done) : [];
            const hasSchedule = (schedules[todayKey] || []).length > 0;

            return (
            <div className="flex-1 overflow-auto p-2 space-y-2 safe-bottom">
              {/* –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è */}
              <div className="bg-gray-800 rounded-lg p-2">
                <div className="flex items-center justify-between mb-1">
                  <span className="text-xs text-gray-400">–°–µ–≥–æ–¥–Ω—è:</span>
                  <span className="text-xs" style={{ color: CONTEXTS[todayContext]?.color }}>{CONTEXTS[todayContext]?.emoji} {CONTEXTS[todayContext]?.name}</span>
                </div>
                <div className="flex gap-1">
                  {Object.entries(SCENARIOS).map(([k, s]) => (
                    <button key={k} onClick={() => setScenarioForDate(todayKey, k)} className={`flex-1 py-1.5 rounded text-xs ${activeScenario === k ? 'bg-orange-600' : 'bg-gray-700'}`}>
                      <div className="font-bold">{s.name}</div>
                      <div className="text-gray-300" style={{ fontSize: '8px' }}>{s.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞ ‚Äî –º—ã—Å–ª–∏ + —Ü–µ–ª–∏ + –º–µ—Ç—Ä–∏–∫–∏ */}
              {contextProject && (
                <div className="rounded-lg p-2" style={{ backgroundColor: PROJECTS[contextProject]?.color + '22', border: `1px solid ${PROJECTS[contextProject]?.color}44` }}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-1">
                      <span style={{ color: PROJECTS[contextProject]?.color }}>{PROJECTS[contextProject]?.emoji}</span>
                      <span className="text-sm font-medium">{PROJECTS[contextProject]?.name}</span>
                    </div>
                    <span className="text-xs text-gray-500">{getContextFromSchedule ? 'üìÖ –∏–∑ –ø–ª–∞–Ω–∞' : 'üìÜ –∏–∑ –¥–Ω—è'}</span>
                  </div>

                  {contextDump.length > 0 && (
                    <div className="mb-2">
                      <div className="text-xs text-gray-400 mb-0.5">üß† –ú—ã—Å–ª–∏ ({contextDump.length}):</div>
                      <div className="space-y-0.5">
                        {contextDump.slice(0, 3).map(d => (
                          <div key={d.id} className="text-xs bg-gray-900/50 rounded px-1.5 py-0.5 truncate">{d.text}</div>
                        ))}
                        {contextDump.length > 3 && <div className="text-xs text-gray-500">+{contextDump.length - 3} –µ—â—ë...</div>}
                      </div>
                    </div>
                  )}

                  {contextGoals.length > 0 && (
                    <div className="mb-2">
                      <div className="text-xs text-gray-400 mb-0.5">üéØ –¶–µ–ª–∏:</div>
                      <div className="space-y-0.5">
                        {contextGoals.slice(0, 3).map(g => (
                          <div key={g.id} onClick={() => toggleGoal(g.id)} className="flex items-center gap-1 text-xs bg-gray-900/50 rounded px-1.5 py-0.5 cursor-pointer">
                            <div className="w-3 h-3 rounded border border-gray-600 flex items-center justify-center text-xs"></div>
                            <span className="truncate">{g.text}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {METRICS_CONFIG[contextProject] && (
                    <div>
                      <div className="text-xs text-gray-400 mb-0.5">üìä –ú–µ—Ç—Ä–∏–∫–∏:</div>
                      <div className="flex flex-wrap gap-2 text-xs">
                        {METRICS_CONFIG[contextProject].filter(m => m.type === 'number').slice(0, 2).map(m => (
                          <span key={m.key} className="bg-gray-900/50 rounded px-1.5 py-0.5">
                            {m.label}: {metrics[contextProject]?.[m.key] || 0}{m.target ? `/${m.target}` : ''}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              <div className="bg-gray-800 rounded-lg p-2">
                <div className="text-sm font-bold mb-1">üéØ –§–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏</div>
                <input type="text" value={weekFocus} onChange={(e) => setWeekFocus(e.target.value)} placeholder="–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å..." className="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm" />
              </div>

              {triggers.map(section => (
                <div key={section.id} className="bg-gray-800 rounded-lg overflow-hidden">
                  <div className="px-3 py-2 bg-gray-700/50 border-b border-gray-700">
                    <div className="font-medium text-sm">{section.title}</div>
                    {section.subtitle && <div className="text-xs text-gray-400">{section.subtitle}</div>}
                  </div>

                  <div className="divide-y divide-gray-700/50">
                    {section.items.map(item => (
                      <div
                        key={item.key}
                        onClick={() => setCheckedTriggers(prev => ({ ...prev, [item.key]: !prev[item.key] }))}
                        className={`px-3 py-2 cursor-pointer transition-colors ${
                          checkedTriggers[item.key] ? 'bg-green-900/30' : 'hover:bg-gray-700/50'
                        } ${item.indent ? 'pl-8' : ''} ${item.highlight ? 'bg-orange-900/20' : ''}`}
                      >
                        <div className="flex items-start gap-2">
                          <div className={`w-5 h-5 rounded-md border-2 flex items-center justify-center shrink-0 mt-0.5 ${
                            checkedTriggers[item.key]
                              ? 'bg-green-600 border-green-600'
                              : item.highlight ? 'border-orange-500' : 'border-gray-500'
                          }`}>
                            {checkedTriggers[item.key] && <span className="text-white text-xs">‚úì</span>}
                          </div>

                          <div className="flex-1 min-w-0">
                            <div className={`font-medium text-sm ${checkedTriggers[item.key] ? 'line-through text-gray-500' : ''}`}>
                              {item.title}
                            </div>
                            <div className="text-xs text-gray-400 mt-0.5">{item.desc}</div>

                            {(item.anchor || item.warn) && (
                              <div className="flex flex-wrap gap-1 mt-1">
                                {item.anchor && (
                                  <span className="text-xs px-1.5 py-0.5 bg-blue-900/40 text-blue-300 rounded">
                                    üìç {item.anchor}
                                  </span>
                                )}
                                {item.warn && (
                                  <span className="text-xs px-1.5 py-0.5 bg-red-900/40 text-red-300 rounded">
                                    ‚ö†Ô∏è {item.warn}
                                  </span>
                                )}
                              </div>
                            )}

                            {item.next && !checkedTriggers[item.key] && (
                              <div className="text-xs text-gray-600 mt-1">‚Üì –¥–∞–ª–µ–µ</div>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}

              {(() => {
                const allKeys = triggers.flatMap(s => s.items.map(i => i.key));
                const checked = allKeys.filter(k => checkedTriggers[k]).length;
                const percent = Math.round(checked / allKeys.length * 100);
                return (
                  <div className="bg-gray-800 rounded-lg p-3">
                    <div className="flex items-center justify-between text-xs mb-1">
                      <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è</span>
                      <span className="text-green-400">{checked}/{allKeys.length} ({percent}%)</span>
                    </div>
                    <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
                      <div className="h-full bg-green-600 transition-all" style={{ width: `${percent}%` }}></div>
                    </div>
                  </div>
                );
              })()}

              <button onClick={() => setCheckedTriggers({})} className="w-full py-2 text-xs text-gray-500 hover:text-gray-300">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã</button>
              <div className="bg-orange-900/20 border border-orange-800 rounded p-2 text-xs text-orange-200 italic">
                "–ü–æ–∫–∞–∑–∞–ª –∑–∞–¥–∞—á—É, –æ—Ç–æ—à—ë–ª. –ó–∞—Ö–≤–∞—Ç–∏–ª–æ ‚Äî –µ–¥—É."
              </div>
            </div>
          );})()}

          {/* GOALS TAB */}
          {tab === 'goals' && (() => {
            const totalGoals = goals.length;
            const completedGoals = goals.filter(g => g.done).length;
            const progressPercent = totalGoals > 0 ? Math.round(completedGoals / totalGoals * 100) : 0;

            return (
            <div className="flex-1 overflow-auto safe-bottom">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º */}
              <div className="bg-gray-800 border-b border-gray-700 px-3 py-2">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-lg font-bold">üéØ –¶–µ–ª–∏</div>
                  <div className="text-sm text-gray-400">{completedGoals}/{totalGoals}</div>
                </div>
                <div className="h-1.5 bg-gray-700 rounded-full overflow-hidden">
                  <div className="h-full bg-green-500 transition-all" style={{ width: `${progressPercent}%` }}></div>
                </div>
              </div>

              <div className="p-3 space-y-3">
                {/* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª–∏ */}
                <div className="bg-gray-800 rounded-xl p-3">
                  <div className="text-sm font-bold mb-2 text-gray-400">–î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å</div>
                  <input
                    type="text"
                    value={newGoalText}
                    onChange={(e) => setNewGoalText(e.target.value)}
                    placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?"
                    className="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm mb-2"
                    onKeyDown={(e) => e.key === 'Enter' && addGoal()}
                  />
                  <div className="flex gap-2">
                    <select value={newGoalProject} onChange={(e) => setNewGoalProject(e.target.value)} className="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-2 py-1.5 text-xs">
                      <option value="">üìÅ –ü—Ä–æ–µ–∫—Ç</option>
                      {Object.entries(PROJECTS).map(([k, v]) => <option key={k} value={k}>{v.emoji} {v.name}</option>)}
                    </select>
                    <select value={newGoalPeriod} onChange={(e) => setNewGoalPeriod(e.target.value)} className="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-2 py-1.5 text-xs">
                      <option value="">‚è∞ –°—Ä–æ–∫</option>
                      <option value="D">–î–µ–Ω—å</option>
                      <option value="W">–ù–µ–¥–µ–ª—è</option>
                      <option value="M">–ú–µ—Å—è—Ü</option>
                      <option value="Q">–ö–≤–∞—Ä—Ç–∞–ª</option>
                    </select>
                    <button onClick={addGoal} className="px-4 py-1.5 bg-orange-600 hover:bg-orange-500 rounded-lg text-sm font-bold transition-colors">+</button>
                  </div>
                </div>

                {/* –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º */}
                <div className="bg-gray-800 rounded-xl p-3">
                  <div className="flex gap-1.5 flex-wrap">
                    <button
                      onClick={() => setGoalsFilter('')}
                      className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${goalsFilter === '' ? 'bg-orange-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}
                    >
                      –í—Å–µ
                    </button>
                    {Object.entries(PROJECTS).map(([k, v]) => (
                      <button
                        key={k}
                        onClick={() => setGoalsFilter(k)}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${goalsFilter === k ? 'ring-2 ring-offset-2 ring-offset-gray-900' : ''}`}
                        style={{
                          backgroundColor: goalsFilter === k ? v.color : `${v.color}33`,
                          color: goalsFilter === k ? 'white' : v.color,
                          '--tw-ring-color': v.color
                        }}
                      >
                        {v.emoji} {v.name}
                      </button>
                    ))}
                  </div>
                </div>

                {/* –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ */}
                {goalsFilter && METRICS_CONFIG[goalsFilter] && (
                  <div className="rounded-xl p-3" style={{ backgroundColor: PROJECTS[goalsFilter]?.color + '22', border: `1px solid ${PROJECTS[goalsFilter]?.color}44` }}>
                    <div className="flex items-center gap-2 mb-3">
                      <span className="text-xl">{PROJECTS[goalsFilter]?.emoji}</span>
                      <div>
                        <div className="font-bold">{PROJECTS[goalsFilter]?.name}</div>
                        <div className="text-xs text-gray-400">–ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ–¥–µ–ª–∏</div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      {METRICS_CONFIG[goalsFilter].map(m => (
                        <div key={m.key} className="bg-gray-900/50 rounded-lg p-2">
                          <div className="text-xs text-gray-400 mb-1">{m.label}</div>
                          {m.type === 'number' && (
                            <div className="flex items-center gap-2">
                              <button onClick={() => updateMetric(goalsFilter, m.key, Math.max(0, (metrics[goalsFilter]?.[m.key] || 0) - 1))} className="w-7 h-7 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">‚àí</button>
                              <span className="text-xl font-bold flex-1 text-center">{metrics[goalsFilter]?.[m.key] || 0}{m.target && <span className="text-sm text-gray-500">/{m.target}</span>}</span>
                              <button onClick={() => updateMetric(goalsFilter, m.key, (metrics[goalsFilter]?.[m.key] || 0) + 1)} className="w-7 h-7 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition-colors">+</button>
                            </div>
                          )}
                          {m.type === 'text' && (
                            <input type="text" value={metrics[goalsFilter]?.[m.key] || ''} onChange={(e) => updateMetric(goalsFilter, m.key, e.target.value)} className="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm" placeholder="..." />
                          )}
                          {m.type === 'checkbox' && (
                            <button onClick={() => updateMetric(goalsFilter, m.key, !metrics[goalsFilter]?.[m.key])} className={`w-full py-2 rounded-lg font-medium transition-colors ${metrics[goalsFilter]?.[m.key] ? 'bg-green-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}>
                              {metrics[goalsFilter]?.[m.key] ? '‚úì –î–∞' : '–ù–µ—Ç'}
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* –°–ø–∏—Å–∫–∏ —Ü–µ–ª–µ–π –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º */}
                {[
                  { key: 'D', label: '–°–µ–≥–æ–¥–Ω—è', emoji: 'üìÖ', color: '#EF4444' },
                  { key: 'W', label: '–≠—Ç–∞ –Ω–µ–¥–µ–ª—è', emoji: 'üìÜ', color: '#F59E0B' },
                  { key: 'M', label: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü', emoji: 'üóì', color: '#3B82F6' },
                  { key: 'Q', label: '–ö–≤–∞—Ä—Ç–∞–ª', emoji: 'üéØ', color: '#8B5CF6' },
                  { key: 'other', label: '–ë–µ–∑ —Å—Ä–æ–∫–∞', emoji: 'üìå', color: '#6B7280' }
                ].map(p => {
                  const filteredGoals = goalsByPeriod[p.key].filter(g => !goalsFilter || g.project === goalsFilter);
                  const periodCompleted = filteredGoals.filter(g => g.done).length;
                  const periodTotal = filteredGoals.length;

                  return filteredGoals.length > 0 && (
                    <div key={p.key} className="bg-gray-800 rounded-xl overflow-hidden">
                      <div className="px-3 py-2 border-b border-gray-700 flex items-center justify-between" style={{ borderLeftWidth: '3px', borderLeftColor: p.color }}>
                        <div className="flex items-center gap-2">
                          <span>{p.emoji}</span>
                          <span className="font-medium text-sm">{p.label}</span>
                        </div>
                        <span className="text-xs text-gray-500">{periodCompleted}/{periodTotal}</span>
                      </div>
                      <div className="divide-y divide-gray-700/50">
                        {filteredGoals.map(g => (
                          <div
                            key={g.id}
                            className={`flex items-center gap-3 px-3 py-2.5 transition-colors ${g.done ? 'bg-green-900/10' : 'hover:bg-gray-700/30'}`}
                          >
                            <button
                              onClick={() => toggleGoal(g.id)}
                              className={`w-5 h-5 rounded-md border-2 flex items-center justify-center shrink-0 transition-all ${g.done ? 'bg-green-600 border-green-600' : 'border-gray-500 hover:border-green-500'}`}
                            >
                              {g.done && <span className="text-white text-xs">‚úì</span>}
                            </button>
                            <div className={`flex-1 text-sm ${g.done ? 'line-through text-gray-500' : ''}`}>{g.text}</div>
                            {g.project && (
                              <span className="px-1.5 py-0.5 rounded text-xs" style={{ backgroundColor: PROJECTS[g.project]?.color + '33', color: PROJECTS[g.project]?.color }}>
                                {PROJECTS[g.project]?.emoji}
                              </span>
                            )}
                            <button onClick={() => deleteGoal(g.id)} className="text-gray-600 hover:text-red-400 transition-colors text-sm">‚úï</button>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}

                {/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */}
                {goals.length === 0 && (
                  <div className="bg-gray-800 rounded-xl p-6 text-center">
                    <div className="text-4xl mb-3">üéØ</div>
                    <div className="text-gray-400 mb-1">–ù–µ—Ç —Ü–µ–ª–µ–π</div>
                    <div className="text-sm text-gray-600">–î–æ–±–∞–≤—å –ø–µ—Ä–≤—É—é —Ü–µ–ª—å –≤—ã—à–µ</div>
                  </div>
                )}
              </div>
            </div>
          );})()}

          {/* BRAIN DUMP TAB */}
          {tab === 'dump' && (() => {
            const filteredDump = brainDump.filter(item => {
              if (!dumpFilter) return true;
              if (dumpFilter === 'none') return !item.project;
              return item.project === dumpFilter;
            });
            const dumpByProject = {};
            brainDump.forEach(item => {
              const p = item.project || 'none';
              if (!dumpByProject[p]) dumpByProject[p] = [];
              dumpByProject[p].push(item);
            });

            return (
            <div className="flex-1 overflow-auto safe-bottom">
              {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
              <div className="bg-gray-800 border-b border-gray-700 px-3 py-2">
                <div className="flex items-center justify-between">
                  <div className="text-lg font-bold">üß† Brain Dump</div>
                  <div className="text-sm text-gray-400">{brainDump.length} –º—ã—Å–ª–µ–π</div>
                </div>
                <div className="text-xs text-gray-500 mt-1">–í—ã–≥—Ä—É–∑–∏ –≤—Å—ë –∏–∑ –≥–æ–ª–æ–≤—ã, —Ä–∞–∑–±–µ—Ä—ë—à—å –ø–æ—Ç–æ–º</div>
              </div>

              <div className="p-3 space-y-3">
                {/* –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ */}
                <div className="bg-gray-800 rounded-xl p-3">
                  <div className="flex gap-2 mb-2">
                    <input
                      type="text"
                      value={newDumpText}
                      onChange={(e) => setNewDumpText(e.target.value)}
                      placeholder="–ß—Ç–æ –∫—Ä—É—Ç–∏—Ç—Å—è –≤ –≥–æ–ª–æ–≤–µ?"
                      className="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2.5 text-sm"
                      onKeyDown={(e) => e.key === 'Enter' && addDump()}
                    />
                    <button onClick={addDump} className="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg font-bold transition-colors">+</button>
                  </div>
                  <div className="flex gap-1.5 flex-wrap">
                    <button
                      onClick={() => setNewDumpProject('')}
                      className={`px-2 py-1 rounded-lg text-xs transition-all ${newDumpProject === '' ? 'bg-gray-600' : 'bg-gray-700 hover:bg-gray-600'}`}
                    >
                      üì• –í—Ö–æ–¥—è—â–∏–µ
                    </button>
                    {Object.entries(PROJECTS).map(([k, v]) => (
                      <button
                        key={k}
                        onClick={() => setNewDumpProject(k)}
                        className={`px-2 py-1 rounded-lg text-xs transition-all`}
                        style={{
                          backgroundColor: newDumpProject === k ? v.color : `${v.color}33`,
                          color: newDumpProject === k ? 'white' : v.color
                        }}
                      >
                        {v.emoji}
                      </button>
                    ))}
                  </div>
                </div>

                {/* –§–∏–ª—å—Ç—Ä—ã */}
                <div className="bg-gray-800 rounded-xl p-3">
                  <div className="flex gap-1.5 flex-wrap">
                    <button
                      onClick={() => setDumpFilter('')}
                      className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${dumpFilter === '' ? 'bg-orange-600 text-white' : 'bg-gray-700 hover:bg-gray-600'}`}
                    >
                      –í—Å–µ ({brainDump.length})
                    </button>
                    {Object.entries(PROJECTS).map(([k, v]) => {
                      const count = dumpByProject[k]?.length || 0;
                      return count > 0 && (
                        <button
                          key={k}
                          onClick={() => setDumpFilter(k)}
                          className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${dumpFilter === k ? 'ring-2 ring-offset-2 ring-offset-gray-900' : ''}`}
                          style={{
                            backgroundColor: dumpFilter === k ? v.color : `${v.color}33`,
                            color: dumpFilter === k ? 'white' : v.color,
                            '--tw-ring-color': v.color
                          }}
                        >
                          {v.emoji} {count}
                        </button>
                      );
                    })}
                    {(dumpByProject['none']?.length || 0) > 0 && (
                      <button
                        onClick={() => setDumpFilter('none')}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${dumpFilter === 'none' ? 'bg-gray-600' : 'bg-gray-700 hover:bg-gray-600'}`}
                      >
                        üì• {dumpByProject['none']?.length || 0}
                      </button>
                    )}
                  </div>
                </div>

                {/* –°–ø–∏—Å–æ–∫ –º—ã—Å–ª–µ–π */}
                {filteredDump.length > 0 ? (
                  <div className="bg-gray-800 rounded-xl overflow-hidden">
                    <div className="divide-y divide-gray-700/50">
                      {filteredDump.map(item => (
                        <div
                          key={item.id}
                          className="flex items-start gap-3 px-3 py-3 hover:bg-gray-700/30 transition-colors group"
                        >
                          {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞ */}
                          <div
                            className="w-1 h-full min-h-[24px] rounded-full shrink-0"
                            style={{ backgroundColor: item.project ? PROJECTS[item.project]?.color : '#6B7280' }}
                          ></div>

                          {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
                          <div className="flex-1 min-w-0">
                            <div className="text-sm">{item.text}</div>
                            <div className="flex items-center gap-2 mt-1">
                              {item.project && (
                                <span className="text-xs px-1.5 py-0.5 rounded" style={{ backgroundColor: PROJECTS[item.project]?.color + '33', color: PROJECTS[item.project]?.color }}>
                                  {PROJECTS[item.project]?.emoji} {PROJECTS[item.project]?.name}
                                </span>
                              )}
                              {item.createdAt && (
                                <span className="text-xs text-gray-600">
                                  {new Date(item.createdAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}
                                </span>
                              )}
                            </div>
                          </div>

                          {/* –î–µ–π—Å—Ç–≤–∏—è */}
                          <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                            <button
                              onClick={() => convertToGoal(item)}
                              className="px-2 py-1 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-lg text-xs transition-colors"
                            >
                              ‚ÜíüéØ
                            </button>
                            <button
                              onClick={() => deleteDump(item.id)}
                              className="px-2 py-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded-lg text-xs transition-colors"
                            >
                              ‚úï
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  <div className="bg-gray-800 rounded-xl p-6 text-center">
                    <div className="text-4xl mb-3">üß†</div>
                    <div className="text-gray-400 mb-1">
                      {dumpFilter ? '–ù–µ—Ç –º—ã—Å–ª–µ–π –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ–µ–∫—Ç—É' : '–ì–æ–ª–æ–≤–∞ —á–∏—Å—Ç–∞—è!'}
                    </div>
                    <div className="text-sm text-gray-600">
                      {dumpFilter ? '–í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π —Ñ–∏–ª—å—Ç—Ä –∏–ª–∏ –¥–æ–±–∞–≤—å –º—ã—Å–ª—å' : '–ó–∞–ø–∏—à–∏ —á—Ç–æ –∫—Ä—É—Ç–∏—Ç—Å—è –≤ –≥–æ–ª–æ–≤–µ'}
                    </div>
                  </div>
                )}

                {/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */}
                <div className="bg-gray-800/50 rounded-xl p-3 text-center">
                  <div className="text-sm text-gray-500 italic">
                    "–ü—Ä–∏–ª–µ—Ç–µ–ª–∞ –º—ã—Å–ª—å ‚Üí —Å—é–¥–∞. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–æ–º—É —á—Ç–æ –¥–µ–ª–∞–ª."
                  </div>
                </div>
              </div>
            </div>
          );})()}

          {/* Scenario Modal */}
          {showScenarioModal && (
            <ScenarioModal
              dateKey={showScenarioModal.dateKey}
              dayOfWeek={showScenarioModal.dayOfWeek}
              onClose={() => setShowScenarioModal(null)}
            />
          )}

          {/* Block Editor */}
          {showBlockEditor && (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setShowBlockEditor(null)}>
              <div className="bg-gray-800 rounded-xl p-4 w-full max-w-xs" onClick={e => e.stopPropagation()}>
                <h3 className="text-sm font-bold mb-3">‚úèÔ∏è {showBlockEditor.name}</h3>
                <div className="space-y-2">
                  <div className="flex gap-2">
                    <input type="text" value={showBlockEditor.emoji} onChange={e => setShowBlockEditor({...showBlockEditor, emoji: e.target.value})} className="w-16 bg-gray-700 rounded px-2 py-1 text-xl text-center" />
                    <input type="color" value={showBlockEditor.color} onChange={e => setShowBlockEditor({...showBlockEditor, color: e.target.value})} className="flex-1 h-10 bg-gray-700 rounded cursor-pointer" />
                  </div>
                  <input type="text" value={showBlockEditor.name} onChange={e => setShowBlockEditor({...showBlockEditor, name: e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1 text-sm" />
                  <div className="flex gap-2 text-xs">
                    <div className="flex-1"><label className="text-gray-400">–î–ª–∏—Ç</label><input type="number" value={showBlockEditor.duration} onChange={e => setShowBlockEditor({...showBlockEditor, duration: +e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1" /></div>
                    <div className="flex-1"><label className="text-gray-400">Min</label><input type="number" value={showBlockEditor.minDur} onChange={e => setShowBlockEditor({...showBlockEditor, minDur: +e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1" /></div>
                    <div className="flex-1"><label className="text-gray-400">Max</label><input type="number" value={showBlockEditor.maxDur} onChange={e => setShowBlockEditor({...showBlockEditor, maxDur: +e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1" /></div>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  <button onClick={() => setShowBlockEditor(null)} className="flex-1 py-1.5 bg-gray-700 rounded text-sm">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={() => { setBlocks(prev => ({ ...prev, [showBlockEditor.id]: showBlockEditor })); setShowBlockEditor(null); }} className="flex-1 py-1.5 bg-green-600 rounded text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<LevOS />);
  </script>
</body>
</html>
