<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LEV OS 2.0">
  <title>ü¶Å LEV OS 2.0</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { margin: 0; background: #111827; overscroll-behavior: none; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    input, select, button, textarea { font-family: inherit; }
    .safe-top { padding-top: env(safe-area-inset-top, 0px); }
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); }
    .timeline-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
    .timeline-scroll::-webkit-scrollbar-track { background: #1f2937; }
    .timeline-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    const storage = {
      get: (key, def) => { try { const item = localStorage.getItem(`levos2_${key}`); return item ? JSON.parse(item) : def; } catch { return def; } },
      set: (key, value) => { try { localStorage.setItem(`levos2_${key}`, JSON.stringify(value)); } catch {} }
    };

    const SLOT_HEIGHT = 18;
    const TIME_SLOTS = [];
    for (let i = 7; i < 24; i++) { TIME_SLOTS.push({ hour: i, label: `${i}`, isHalf: false }); TIME_SLOTS.push({ hour: i + 0.5, label: '', isHalf: true }); }
    for (let i = 0; i < 4; i++) { TIME_SLOTS.push({ hour: i + 24, label: `${i}`, isHalf: false }); TIME_SLOTS.push({ hour: i + 24.5, label: '', isHalf: true }); }

    const roundToHalfHour = (hour) => Math.round(hour * 2) / 2;

    const CATEGORIES = {
      OP: { name: '–û–ø–µ—Ä–∞—Ü–∏–∏', color: '#EF4444' },
      SACRED: { name: '–°–µ–º—å—è', color: '#A855F7' },
      POLECHAT: { name: '–ü–æ–ª–µ—á–∞—Ç', color: '#3B82F6' },
      SOMALAB: { name: '–°–æ–º–∞–ª–∞–±', color: '#F97316' },
      LAB: { name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', color: '#8B5CF6' },
      CARE: { name: '–ó–∞–±–æ—Ç–∞', color: '#22C55E' },
      BUFFER: { name: '–ë—É—Ñ–µ—Ä', color: '#6B7280' },
      NIGHT: { name: '–ù–æ—á—å', color: '#6366F1' },
      FREE: { name: '–°–≤–æ–±–æ–¥–Ω–æ–µ', color: '#EAB308' },
    };

    const DEFAULT_BLOCKS = {
      OP_1: { id: 'OP_1', name: '1 –æ–ø–µ—Ä–∞—Ü–∏—è', emoji: 'üè•', category: 'OP', color: '#EF4444', duration: 180, minDur: 120, maxDur: 240 },
      OP_2: { id: 'OP_2', name: '2 –æ–ø–µ—Ä–∞—Ü–∏–∏', emoji: 'üè•üè•', category: 'OP', color: '#DC2626', duration: 300, minDur: 240, maxDur: 420 },
      OP_3: { id: 'OP_3', name: '3 –æ–ø–µ—Ä–∞—Ü–∏–∏', emoji: 'üè•üè•üè•', category: 'OP', color: '#B91C1C', duration: 420, minDur: 360, maxDur: 540 },
      BUFFER: { id: 'BUFFER', name: '–ë—É—Ñ–µ—Ä', emoji: '‚è≥', category: 'BUFFER', color: '#6B7280', duration: 30, minDur: 15, maxDur: 60 },
      ROAD: { id: 'ROAD', name: '–î–æ—Ä–æ–≥–∞', emoji: 'üö∂', category: 'BUFFER', color: '#4B5563', duration: 25, minDur: 20, maxDur: 40 },
      FAM: { id: 'FAM', name: '50 –º–∏–Ω –ú–∞–π', emoji: 'üë®‚Äçüë©‚Äçüëß', category: 'SACRED', color: '#A855F7', duration: 50, minDur: 30, maxDur: 120 },
      WALK: { id: 'WALK', name: '–ü—Ä–æ–≥—É–ª–∫–∞ –ú–∞–π', emoji: 'üö∂‚Äç‚ôÇÔ∏è', category: 'SACRED', color: '#9333EA', duration: 90, minDur: 60, maxDur: 120 },
      POLECHAT: { id: 'POLECHAT', name: '–ü–æ–ª–µ—á–∞—Ç', emoji: 'üíº', category: 'POLECHAT', color: '#3B82F6', duration: 120, minDur: 30, maxDur: 300 },
      CALL_P: { id: 'CALL_P', name: '–ó–≤–æ–Ω–æ–∫ –ü–æ–ª–µ—á–∞—Ç', emoji: 'üìûüíº', category: 'POLECHAT', color: '#2563EB', duration: 60, minDur: 30, maxDur: 90 },
      SOMALAB: { id: 'SOMALAB', name: '–°–æ–º–∞–ª–∞–±', emoji: '‚ö°', category: 'SOMALAB', color: '#F97316', duration: 90, minDur: 30, maxDur: 180 },
      CALL_S: { id: 'CALL_S', name: '–ó–≤–æ–Ω–æ–∫ –°–æ–º–∞–ª–∞–±', emoji: 'üìû‚ö°', category: 'SOMALAB', color: '#EA580C', duration: 60, minDur: 30, maxDur: 90 },
      LAB: { id: 'LAB', name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', emoji: 'üî¨', category: 'LAB', color: '#8B5CF6', duration: 120, minDur: 60, maxDur: 240 },
      SPORT: { id: 'SPORT', name: '–°–ø–æ—Ä—Ç', emoji: 'üèãÔ∏è', category: 'CARE', color: '#22C55E', duration: 90, minDur: 60, maxDur: 150 },
      SPORT_SPA: { id: 'SPORT_SPA', name: '–°–ø–æ—Ä—Ç+–°–ü–ê', emoji: 'üèãÔ∏èüßñ', category: 'CARE', color: '#16A34A', duration: 150, minDur: 120, maxDur: 180 },
      NAP: { id: 'NAP', name: 'Power Nap', emoji: 'üí§', category: 'CARE', color: '#14B8A6', duration: 30, minDur: 20, maxDur: 45 },
      SLEEP: { id: 'SLEEP', name: '–°–æ–Ω', emoji: 'üò¥', category: 'NIGHT', color: '#6366F1', duration: 480, minDur: 360, maxDur: 540 },
      HYPER: { id: 'HYPER', name: '–ì–∏–ø–µ—Ä—Ñ–æ–∫—É—Å', emoji: 'üî•', category: 'FREE', color: '#F59E0B', duration: 180, minDur: 120, maxDur: 360 },
      FREE: { id: 'FREE', name: '–°–≤–æ–±–æ–¥–Ω–æ–µ', emoji: 'üé®', category: 'FREE', color: '#EAB308', duration: 60, minDur: 30, maxDur: 180 },
    };

    const CONTEXTS = {
      POLECHAT: { name: '–ü–æ–ª–µ—á–∞—Ç', color: '#3B82F6', emoji: 'üíº', blockId: 'POLECHAT' },
      SOMALAB: { name: '–°–æ–º–∞–ª–∞–±', color: '#F97316', emoji: '‚ö°', blockId: 'SOMALAB' },
      LAB: { name: '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', color: '#8B5CF6', emoji: 'üî¨', blockId: 'LAB' },
      FAMILY: { name: '–°–µ–º—å—è', color: '#22C55E', emoji: 'üë®‚Äçüë©‚Äçüëß', blockId: 'FAM' },
    };

    const DEFAULT_WEEK_CONTEXTS = {
      0: 'FAMILY', // –í—Å
      1: 'POLECHAT', // –ü–Ω
      2: 'POLECHAT', // –í—Ç
      3: 'POLECHAT', // –°—Ä
      4: 'LAB', // –ß—Ç
      5: 'SOMALAB', // –ü—Ç
      6: 'FAMILY', // –°–±
    };

    const SCENARIOS = {
      1: { name: '1-–π', desc: '–∫ 9:00', wakeUp: 7, opStart: 9 },
      2: { name: '2-–π', desc: '–∫ 10-11', wakeUp: 8, opStart: 10.5, homeWindow: { start: 8.5, dur: 60 } },
      3: { name: '3-–π', desc: '–∫ 12-15', wakeUp: 10.5, opStart: 14, homeWindow: { start: 11.5, dur: 150 } },
      4: { name: '4+', desc: '>15:00', wakeUp: 11.5, opStart: 17, homeWindow: { start: 12.5, dur: 180 }, canGym: true },
      w: { name: 'üè†', desc: '–≤—ã—Ö–æ–¥–Ω–æ–π', wakeUp: 11, isWeekend: true },
    };

    const PROJECTS = {
      POLECHAT: { name: '–ü–æ–ª–µ—á–∞—Ç', color: '#3B82F6', emoji: 'üíº' },
      SOMALAB: { name: '–°–æ–º–∞–ª–∞–±', color: '#F97316', emoji: '‚ö°' },
      LAB: { name: '–õ–∞–±', color: '#8B5CF6', emoji: 'üî¨' },
      FAMILY: { name: '–°–µ–º—å—è', color: '#A855F7', emoji: 'üë®‚Äçüë©‚Äçüëß' },
      PERSONAL: { name: '–õ–∏—á–Ω–æ–µ', color: '#EAB308', emoji: 'üéØ' },
    };

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
    const getTriggers = (scenario, dayOfWeek, context) => {
      const base = {
        morning: { title: 'üåÖ –£—Ç—Ä–æ', items: [
          { key: 'm1', event: '–í—Å—Ç–∞–ª', action: '–∑—É–±—ã' },
          { key: 'm2', event: '–ó—É–±—ã', action: '–≤–∏—Ç–∞–º–∏–Ω—ã' },
          { key: 'm3', event: '–í–∏—Ç–∞–º–∏–Ω—ã', action: '–∑–∞–ø–∏—Å–∫–∞' },
        ]},
        road: { title: 'üö∂ –î–æ—Ä–æ–≥–∞', items: [
          { key: 'r1', event: '–í—ã—à–µ–ª', action: '—Ä–µ–∂–∏–º?' },
          { key: 'r2', event: '–í–û–°–°–¢', action: 'YouTube' },
          { key: 'r3', event: '–†–ï–ê–ö–¢–ò–í', action: '–æ—Ç–≤–µ—á–∞—é' },
          { key: 'r4', event: '–ê–¢–ê–ö–ê', action: '–ø–∏—à—É' },
        ]},
        hospital: { title: 'üè• –û–ü', items: [
          { key: 'h1', event: '30–º', action: '—Ä–µ–∞–∫—Ç–∏–≤' },
          { key: 'h2', event: '60–º', action: '+–∞—Ç–∞–∫–∏' },
          { key: 'h3', event: '120–º+', action: '–≥–ª—É–±–æ–∫–æ' },
          { key: 'h4', event: '–í—ã—à–µ–ª', action: '"–µ–¥—É"' },
        ]},
        evening: { title: 'üåô –í–µ—á–µ—Ä', items: [
          { key: 'e1', event: '50–º‚úì', action: '–∑–∞–¥–∞—á–∞' },
          { key: 'e2', event: 'YT?', action: '1 –¥–µ–ª–æ' },
          { key: 'e3', event: '–ü—Ä–∏–ª–µ—Ç–µ–ª–æ', action: '–∑–∞–ø–∏—Å–∞—Ç—å' },
        ]},
        sleep: { title: 'üò¥ –°–æ–Ω', items: [
          { key: 's1', event: '–õ–æ–∂—É—Å—å', action: '"–∑–∞–≤—Ç—Ä–∞"' },
          { key: 's2', event: '–ó–∞–ø–∏—Å–∞–ª', action: '–∑—É–±—ã' },
        ]},
      };

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é
      if (scenario === '3' || scenario === '4') {
        base.morning.items.push({ key: 'm_big', event: '‚≠ê', action: '–±–æ–ª—å—à–æ–µ –æ–∫–Ω–æ!' });
        base.morning.items.push({ key: 'm_deep', event: '–û–∫–Ω–æ', action: `—Ä–∞–±–æ—Ç–∞ ${CONTEXTS[context]?.name || ''}` });
      }

      if (scenario === '4') {
        base.morning.items.push({ key: 'm_gym', event: '–û–ü <15:00', action: '–º–æ–∂–Ω–æ –≤ –∑–∞–ª!' });
      }

      // –í—Ç–æ—Ä–Ω–∏–∫/–ß–µ—Ç–≤–µ—Ä–≥ ‚Äî –æ—Ñ–∏—Å
      if (dayOfWeek === 2 || dayOfWeek === 4) {
        base.hospital.items.push({ key: 'h_office', event: '–ü–æ—Å–ª–µ –û–ü', action: '–æ—Ñ–∏—Å' });
      }

      // –í—ã—Ö–æ–¥–Ω–æ–π
      if (scenario === 'w') {
        base.morning = { title: 'üåÖ –£—Ç—Ä–æ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ', items: [
          { key: 'wm1', event: '–í—Å—Ç–∞–ª', action: '–∑—É–±—ã' },
          { key: 'wm2', event: '–ó—É–±—ã', action: '–≤–∏—Ç–∞–º–∏–Ω—ã' },
          { key: 'wm3', event: '–£—Ç—Ä–æ', action: '—Å–µ–º—å—è' },
        ]};
        base.road = { title: 'üë®‚Äçüë©‚Äçüëß –î–µ–Ω—å', items: [
          { key: 'wd1', event: '~14:00', action: '–ø—Ä–æ–≥—É–ª–∫–∞ —Å –ú–∞–π' },
          { key: 'wd2', event: '–°–≤–æ–±–æ–¥–Ω–æ', action: '—Å–ø–æ—Ä—Ç' },
        ]};
        delete base.hospital;
      }

      // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ ‚Äî –æ—Ç—á—ë—Ç
      if (dayOfWeek === 0) {
        base.evening.items.push({ key: 'e_report', event: '21:00', action: '–æ—Ç—á—ë—Ç –∏–Ω–≤–µ—Å—Ç–æ—Ä—É' });
        base.evening.items.push({ key: 'e_review', event: '–ü–æ—Å–ª–µ', action: '–æ–±–∑–æ—Ä —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤' });
      }

      return base;
    };

    const genId = () => Math.random().toString(36).substr(2, 9);
    const formatDate = (d) => d.toISOString().split('T')[0];

    const LevOS = () => {
      const [tab, setTab] = useState('plan');
      const [blocks, setBlocks] = useState(() => storage.get('blocks', DEFAULT_BLOCKS));
      const [schedules, setSchedules] = useState(() => storage.get('schedules', {}));
      const [weekContexts, setWeekContexts] = useState(() => storage.get('weekContexts', DEFAULT_WEEK_CONTEXTS));
      const [weekStart, setWeekStart] = useState(() => { const d = new Date(); d.setDate(d.getDate() - d.getDay() + 1); d.setHours(0,0,0,0); return d; });
      const [selectedBlock, setSelectedBlock] = useState(null);
      const [movingBlock, setMovingBlock] = useState(null);
      const [goals, setGoals] = useState(() => storage.get('goals', []));
      const [brainDump, setBrainDump] = useState(() => storage.get('brainDump', []));
      const [checkedTriggers, setCheckedTriggers] = useState(() => storage.get('triggers', {}));
      const [weekFocus, setWeekFocus] = useState(() => storage.get('weekFocus', ''));
      const [metrics, setMetrics] = useState(() => storage.get('metrics', {
        POLECHAT: { contacts: 0, pilots: 0, legal: 0 },
        LAB: { grants: 0, publications: 0, talks: 0 },
        SOMALAB: { revenue: '', b2cProgress: '' },
        PERSONAL: { workouts: 0, maiTime: false }
      }));
      const [showBlockEditor, setShowBlockEditor] = useState(null);
      const [showScenarioModal, setShowScenarioModal] = useState(null); // { dateKey, dayOfWeek }
      const [newGoalText, setNewGoalText] = useState('');
      const [newGoalProject, setNewGoalProject] = useState('');
      const [newGoalPeriod, setNewGoalPeriod] = useState('');
      const [newDumpText, setNewDumpText] = useState('');
      const [newDumpProject, setNewDumpProject] = useState('');
      const [dumpFilter, setDumpFilter] = useState('');
      const [goalsFilter, setGoalsFilter] = useState('');
      const [todayScenario, setTodayScenario] = useState(() => storage.get('todayScenario', { date: '', scenario: '' }));

      useEffect(() => { storage.set('schedules', schedules); }, [schedules]);
      useEffect(() => { storage.set('blocks', blocks); }, [blocks]);
      useEffect(() => { storage.set('weekContexts', weekContexts); }, [weekContexts]);
      useEffect(() => { storage.set('goals', goals); }, [goals]);
      useEffect(() => { storage.set('brainDump', brainDump); }, [brainDump]);
      useEffect(() => { storage.set('triggers', checkedTriggers); }, [checkedTriggers]);
      useEffect(() => { storage.set('weekFocus', weekFocus); }, [weekFocus]);
      useEffect(() => { storage.set('metrics', metrics); }, [metrics]);
      useEffect(() => { storage.set('todayScenario', todayScenario); }, [todayScenario]);

      const weekDays = useMemo(() => Array.from({ length: 7 }, (_, i) => {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        return d;
      }), [weekStart]);

      const todayKey = formatDate(new Date());
      const todayDayOfWeek = new Date().getDay();
      const todayContext = weekContexts[todayDayOfWeek];
      const isWeekend = todayDayOfWeek === 0 || todayDayOfWeek === 6;

      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
      const detectScenarioFromSchedule = useCallback((schedule) => {
        if (!schedule || schedule.length === 0) return null;
        const opBlock = schedule.find(b => b.blockId && b.blockId.startsWith('OP'));
        if (!opBlock) return isWeekend ? 'w' : null;
        const opStart = opBlock.startHour;
        if (opStart <= 9.5) return '1';
        if (opStart <= 11.5) return '2';
        if (opStart <= 15) return '3';
        return '4';
      }, [isWeekend]);

      // –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–≥–∏–±—Ä–∏–¥–Ω–æ)
      const activeScenario = useMemo(() => {
        // –ï—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π —É–∂–µ –≤—ã–±—Ä–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (todayScenario.date === todayKey && todayScenario.scenario) {
          return todayScenario.scenario;
        }
        // –ò–Ω–∞—á–µ –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        const todaySchedule = schedules[todayKey];
        const detected = detectScenarioFromSchedule(todaySchedule);
        return detected;
      }, [todayKey, todayScenario, schedules, detectScenarioFromSchedule]);

      // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      const setScenarioForToday = useCallback((scenario) => {
        setTodayScenario({ date: todayKey, scenario });
      }, [todayKey]);

      // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
      const getCurrentActiveBlock = useCallback(() => {
        const todaySchedule = schedules[todayKey] || [];
        const now = new Date();
        const currentHour = now.getHours() + now.getMinutes() / 60;

        // –ò—â–µ–º –±–ª–æ–∫, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ø–∞–¥–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
        for (const item of todaySchedule) {
          const endHour = item.startHour + item.duration / 60;
          // –î–ª—è –Ω–æ—á–Ω—ã—Ö —á–∞—Å–æ–≤ (24+) –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
          const normalizedStart = item.startHour >= 24 ? item.startHour - 24 : item.startHour;
          const normalizedEnd = endHour >= 24 ? endHour - 24 : endHour;

          if (item.startHour < 24 && currentHour >= item.startHour && currentHour < endHour) {
            return item;
          }
          // –ù–æ—á–Ω—ã–µ –±–ª–æ–∫–∏
          if (item.startHour >= 24 && currentHour >= normalizedStart && currentHour < normalizedEnd) {
            return item;
          }
        }
        return null;
      }, [schedules, todayKey]);

      // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–∫–∞–∫–æ–π –ø—Ä–æ–µ–∫—Ç —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω)
      const getContextFromSchedule = useMemo(() => {
        const todaySchedule = schedules[todayKey] || [];

        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ä–∞–±–æ—á–∏–µ –±–ª–æ–∫–∏ (–ü–æ–ª–µ—á–∞—Ç, –õ–∞–±, –°–æ–º–∞–ª–∞–±)
        const workBlocks = todaySchedule.filter(b =>
          b.blockId === 'POLECHAT' || b.blockId === 'LAB' || b.blockId === 'SOMALAB'
        );

        if (workBlocks.length === 0) return null;

        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π –±–ª–æ–∫ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –ø—Ä–æ–µ–∫—Ç
        const blockToProject = {
          'POLECHAT': 'POLECHAT',
          'LAB': 'LAB',
          'SOMALAB': 'SOMALAB'
        };

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –±–ª–æ–∫ (–∏–ª–∏ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
        return blockToProject[workBlocks[0].blockId];
      }, [schedules, todayKey]);

      const hasCollision = useCallback((schedule, newStart, newDuration, excludeIds = []) => {
        const newEnd = newStart + newDuration / 60;
        return schedule.some(b => !excludeIds.includes(b.id) && newStart < b.startHour + b.duration / 60 && newEnd > b.startHour);
      }, []);

      const generateAutoBlocks = useCallback((opStart, opDuration) => {
        const opEnd = opStart + opDuration / 60;
        const result = [];
        const ts = Date.now();
        const roadStart = roundToHalfHour(opStart - 0.5);
        if (roadStart >= 7) result.push({ id: `ROAD-${ts}`, blockId: 'ROAD', startHour: roadStart, duration: 25, auto: true });
        result.push({ id: `BUFFER-${ts}`, blockId: 'BUFFER', startHour: roundToHalfHour(opEnd), duration: 30, auto: true });
        const famStart = roundToHalfHour(opEnd + 0.5);
        if (famStart < 22) result.push({ id: `FAM-${ts}`, blockId: 'FAM', startHour: famStart, duration: 50, auto: true });
        return result;
      }, []);

      const recalculateAutoBlocks = useCallback((schedule, opBlock) => {
        const nonAuto = schedule.filter(b => !b.auto);
        return [...nonAuto, ...generateAutoBlocks(opBlock.startHour, opBlock.duration)];
      }, [generateAutoBlocks]);

      // Apply scenario with OP count and context
      const applyScenario = useCallback((dateKey, scenarioKey, opCount, contextKey) => {
        const scenario = SCENARIOS[scenarioKey];
        const context = CONTEXTS[contextKey];
        const schedule = [];
        const ts = Date.now();

        const opBlockId = opCount === 1 ? 'OP_1' : opCount === 2 ? 'OP_2' : 'OP_3';
        const opDuration = blocks[opBlockId].duration;

        if (scenario.isWeekend) {
          schedule.push({ id: `SLEEP-${ts}`, blockId: 'SLEEP', startHour: 24, duration: 480 });
          schedule.push({ id: `FAM-${ts}`, blockId: 'FAM', startHour: 12, duration: 120 });
          schedule.push({ id: `WALK-${ts}`, blockId: 'WALK', startHour: 14, duration: 90 });
          schedule.push({ id: `SPORT-${ts}`, blockId: 'SPORT_SPA', startHour: 16, duration: 150 });
          schedule.push({ id: `HYPER-${ts}`, blockId: 'HYPER', startHour: 20, duration: 180 });
        } else {
          const sleepStart = scenario.wakeUp - 8 + 24;
          schedule.push({ id: `SLEEP-${ts}`, blockId: 'SLEEP', startHour: sleepStart, duration: 480 });
          
          if (scenario.homeWindow) {
            schedule.push({ id: `HOME-${ts}`, blockId: context.blockId, startHour: scenario.homeWindow.start, duration: scenario.homeWindow.dur });
          }
          
          schedule.push({ id: `ROAD-${ts}`, blockId: 'ROAD', startHour: scenario.opStart - 0.5, duration: 25, auto: true });
          schedule.push({ id: `OP-${ts}`, blockId: opBlockId, startHour: scenario.opStart, duration: opDuration });
          
          const opEnd = scenario.opStart + opDuration / 60;
          schedule.push({ id: `BUFFER-${ts}`, blockId: 'BUFFER', startHour: roundToHalfHour(opEnd), duration: 30, auto: true });
          schedule.push({ id: `ROAD2-${ts}`, blockId: 'ROAD', startHour: roundToHalfHour(opEnd + 0.5), duration: 25, auto: true });
          
          const famStart = roundToHalfHour(opEnd + 1);
          schedule.push({ id: `FAM-${ts}`, blockId: 'FAM', startHour: famStart, duration: 50, auto: true });
          
          schedule.push({ id: `EVE-${ts}`, blockId: context.blockId, startHour: roundToHalfHour(famStart + 1), duration: 180 });
          
          if (scenario.canGym) schedule.push({ id: `SPORT-${ts}`, blockId: 'SPORT', startHour: 15, duration: 90 });
        }
        
        setSchedules(prev => ({ ...prev, [dateKey]: schedule }));
        setShowScenarioModal(null);
      }, [blocks]);

      const placeBlock = useCallback((dateKey, hour) => {
        if (!selectedBlock) return;
        const blockDef = blocks[selectedBlock];
        if (!blockDef || (selectedBlock.startsWith('OP') && hour >= 21)) return;
        const schedule = schedules[dateKey] || [];
        if (hasCollision(schedule, hour, blockDef.duration)) return;
        let newSchedule = [...schedule, { id: `${selectedBlock}-${Date.now()}`, blockId: selectedBlock, startHour: hour, duration: blockDef.duration }];
        if (selectedBlock.startsWith('OP')) newSchedule = [...newSchedule, ...generateAutoBlocks(hour, blockDef.duration)];
        setSchedules(prev => ({ ...prev, [dateKey]: newSchedule }));
        setSelectedBlock(null);
      }, [selectedBlock, schedules, blocks, hasCollision, generateAutoBlocks]);

      const moveBlock = useCallback((toDateKey, newHour) => {
        if (!movingBlock) return;
        const { id, dateKey: fromDateKey } = movingBlock;
        const fromSchedule = schedules[fromDateKey] || [];
        const block = fromSchedule.find(b => b.id === id);
        if (!block || (block.blockId.startsWith('OP') && newHour >= 21)) return;
        const toSchedule = fromDateKey === toDateKey ? fromSchedule : (schedules[toDateKey] || []);
        const excludeIds = block.blockId.startsWith('OP') ? [id, ...fromSchedule.filter(b => b.auto).map(b => b.id)] : [id];
        if (hasCollision(toSchedule.filter(b => fromDateKey !== toDateKey || !excludeIds.includes(b.id)), newHour, block.duration)) return;
        let newFromSchedule = fromSchedule.filter(b => b.id !== id);
        if (block.blockId.startsWith('OP')) newFromSchedule = newFromSchedule.filter(b => !b.auto);
        let newToSchedule = fromDateKey === toDateKey ? newFromSchedule : [...toSchedule];
        newToSchedule = [...newToSchedule, { ...block, startHour: newHour }];
        if (block.blockId.startsWith('OP')) newToSchedule = [...newToSchedule, ...generateAutoBlocks(newHour, block.duration)];
        setSchedules(prev => ({ ...prev, [fromDateKey]: newFromSchedule, [toDateKey]: newToSchedule }));
        setMovingBlock(null);
      }, [movingBlock, schedules, hasCollision, generateAutoBlocks]);

      const resizeBlock = useCallback((dateKey, blockId, delta) => {
        const schedule = schedules[dateKey] || [];
        const block = schedule.find(b => b.id === blockId);
        if (!block) return;
        const def = blocks[block.blockId];
        if (!def) return;
        const newDuration = block.duration + delta;
        if (newDuration < def.minDur || newDuration > def.maxDur) return;
        const excludeIds = block.blockId.startsWith('OP') ? [blockId, ...schedule.filter(b => b.auto).map(b => b.id)] : [blockId];
        if (delta > 0 && hasCollision(schedule, block.startHour, newDuration, excludeIds)) return;
        let newSchedule = schedule.map(b => b.id === blockId ? { ...b, duration: newDuration } : b);
        if (block.blockId.startsWith('OP')) newSchedule = recalculateAutoBlocks(newSchedule, { ...block, duration: newDuration });
        setSchedules(prev => ({ ...prev, [dateKey]: newSchedule }));
      }, [schedules, blocks, hasCollision, recalculateAutoBlocks]);

      const removeBlock = useCallback((dateKey, blockId) => {
        const schedule = schedules[dateKey] || [];
        const block = schedule.find(b => b.id === blockId);
        let newSchedule = schedule.filter(b => b.id !== blockId);
        if (block?.blockId.startsWith('OP')) newSchedule = newSchedule.filter(b => !b.auto);
        setSchedules(prev => ({ ...prev, [dateKey]: newSchedule }));
      }, [schedules]);

      const changeWeek = (delta) => setWeekStart(prev => { const d = new Date(prev); d.setDate(d.getDate() + delta * 7); return d; });
      const goToToday = () => { const d = new Date(); d.setDate(d.getDate() - d.getDay() + 1); d.setHours(0,0,0,0); setWeekStart(d); };

      const blocksByCategory = useMemo(() => {
        const result = {};
        Object.values(blocks).forEach(b => {
          if (b.category !== 'BUFFER') {
            if (!result[b.category]) result[b.category] = [];
            result[b.category].push(b);
          }
        });
        return result;
      }, [blocks]);

      const addGoal = () => {
        if (!newGoalText.trim()) return;
        setGoals(prev => [...prev, { id: genId(), text: newGoalText, project: newGoalProject, period: newGoalPeriod, done: false }]);
        setNewGoalText('');
      };
      const toggleGoal = (id) => setGoals(prev => prev.map(g => g.id === id ? { ...g, done: !g.done } : g));
      const deleteGoal = (id) => setGoals(prev => prev.filter(g => g.id !== id));

      const addDump = () => {
        if (!newDumpText.trim()) return;
        setBrainDump(prev => [{ id: genId(), text: newDumpText, project: newDumpProject, createdAt: new Date().toISOString() }, ...prev]);
        setNewDumpText('');
        setNewDumpProject('');
      };
      const deleteDump = (id) => setBrainDump(prev => prev.filter(d => d.id !== id));
      const convertToGoal = (item) => {
        setGoals(prev => [...prev, { id: genId(), text: item.text, project: item.project || '', period: 'D', done: false }]);
        deleteDump(item.id);
      };

      const goalsByPeriod = useMemo(() => {
        const p = { D: [], W: [], M: [], Q: [], other: [] };
        goals.forEach(g => { if (p[g.period]) p[g.period].push(g); else p.other.push(g); });
        return p;
      }, [goals]);

      const updateMetric = (project, field, value) => {
        setMetrics(prev => ({
          ...prev,
          [project]: { ...prev[project], [field]: value }
        }));
      };

      const METRICS_CONFIG = {
        POLECHAT: [
          { key: 'contacts', label: '–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –≤—Ä–∞—á–∞–º–∏', type: 'number', target: 5 },
          { key: 'pilots', label: '–ü–∏–ª–æ—Ç–æ–≤/–ø–ª–∞—Ç—è—â–∏—Ö', type: 'number' },
          { key: 'legal', label: '–Æ—Ä. –≤–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–∫—Ä—ã—Ç–æ', type: 'number' },
        ],
        LAB: [
          { key: 'grants', label: '–ó–∞—è–≤–æ–∫ –Ω–∞ –≥—Ä–∞–Ω—Ç—ã', type: 'number' },
          { key: 'publications', label: '–ü—É–±–ª–∏–∫–∞—Ü–∏–π –≤ —Ä–∞–±–æ—Ç–µ', type: 'number' },
          { key: 'talks', label: '–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π', type: 'number' },
        ],
        SOMALAB: [
          { key: 'revenue', label: '–í—ã—Ä—É—á–∫–∞', type: 'text' },
          { key: 'b2cProgress', label: '–ü—Ä–æ–≥—Ä–µ—Å—Å B2C', type: 'text' },
        ],
        PERSONAL: [
          { key: 'workouts', label: '–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫', type: 'number', target: 2 },
          { key: 'maiTime', label: '50 –º–∏–Ω —Å –ú–∞–π —Å–µ–≥–æ–¥–Ω—è', type: 'checkbox' },
        ],
      };

      // Day Column
      const DayColumn = ({ date, schedule, dateKey, prevSchedule }) => {
        const dayOfWeek = date.getDay();
        const isToday = dateKey === todayKey;
        const contextKey = weekContexts[dayOfWeek];
        const context = CONTEXTS[contextKey];
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–ª–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–∏–π
        const overflowSleep = useMemo(() => {
          if (!prevSchedule) return null;
          const sleepBlock = prevSchedule.find(b => b.blockId === 'SLEEP');
          if (!sleepBlock) return null;
          // startHour >= 24 –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —ç—Ç–æ –Ω–æ—á–Ω—ã–µ —á–∞—Å—ã (00:00+)
          // –ï—Å–ª–∏ —Å–æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏ –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 4 —É—Ç—Ä–∞ (–∫–æ–≥–¥–∞ —à–∫–∞–ª–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ prev day)
          const endHour = sleepBlock.startHour + sleepBlock.duration / 60;
          // –®–∫–∞–ª–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 27.5 (03:30). –ï—Å–ª–∏ —Å–æ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ ‚Äî —á–∞—Å—Ç—å –ø–µ—Ä–µ–ª–∏–≤–∞–µ—Ç—Å—è
          if (sleepBlock.startHour >= 24 && endHour > 28) {
            const overflowStart = 7; // –Ω–∞—á–∞–ª–æ —à–∫–∞–ª—ã —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
            const overflowEnd = Math.min(endHour - 24, 12); // –∫–æ–Ω–µ—Ü overflow (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 7-12)
            const overflowDuration = (overflowEnd - overflowStart) * 60;
            if (overflowDuration > 0) {
              return {
                ...sleepBlock,
                startHour: overflowStart,
                duration: overflowDuration,
                isOverflow: true,
                totalDuration: sleepBlock.duration // –ø–æ–ª–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
              };
            }
          }
          return null;
        }, [prevSchedule]);

        return (
          <div className="flex-1 min-w-0 border-r border-gray-800 last:border-r-0 flex flex-col">
            {/* Header */}
            <div 
              className={`sticky top-0 z-10 p-0.5 text-center border-b border-gray-700 cursor-pointer ${isToday ? 'bg-orange-900/50' : 'bg-gray-800'}`}
              onClick={() => setShowScenarioModal({ dateKey, dayOfWeek })}
            >
              <div className="flex items-center justify-center gap-1">
                <span className={`font-bold ${isWeekend ? 'text-orange-300' : ''}`} style={{ fontSize: '11px' }}>{dayNames[dayOfWeek]}</span>
                <span className={`${isToday ? 'text-orange-300' : 'text-gray-400'}`} style={{ fontSize: '11px' }}>{date.getDate()}</span>
              </div>
              <div 
                className="px-1 py-0.5 rounded mx-0.5" 
                style={{ backgroundColor: context.color + '33', color: context.color, fontSize: '9px' }}
              >
                {context.emoji} {context.name}
              </div>
              <div className="text-gray-500 mt-0.5" style={{ fontSize: '8px' }}>—Ç–∞–ø = –ø–ª–∞–Ω</div>
            </div>

            {/* Slots */}
            <div className="relative flex-1" style={{ minHeight: TIME_SLOTS.length * SLOT_HEIGHT }}>
              {TIME_SLOTS.map((slot, idx) => (
                <div
                  key={slot.hour}
                  onClick={() => {
                    if (movingBlock) moveBlock(dateKey, slot.hour);
                    else if (selectedBlock) placeBlock(dateKey, slot.hour);
                  }}
                  className={`absolute left-0 right-0 border-b ${slot.isHalf ? 'border-gray-900/50' : 'border-gray-800/50'} ${(selectedBlock || movingBlock) ? 'hover:bg-green-900/30 cursor-pointer' : ''} ${slot.hour >= 24 ? 'bg-purple-900/10' : ''}`}
                  style={{ top: idx * SLOT_HEIGHT, height: SLOT_HEIGHT }}
                />
              ))}

              {/* Overflow —Å–æ–Ω –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è */}
              {overflowSleep && (() => {
                const def = blocks[overflowSleep.blockId];
                if (!def) return null;
                const startIdx = TIME_SLOTS.findIndex(s => s.hour === overflowSleep.startHour);
                if (startIdx === -1) return null;
                const top = startIdx * SLOT_HEIGHT;
                const height = (overflowSleep.duration / 30) * SLOT_HEIGHT - 1;
                const totalHours = Math.round(overflowSleep.totalDuration / 60 * 10) / 10;

                return (
                  <div
                    key="overflow-sleep"
                    className="absolute left-0.5 right-0.5 rounded overflow-hidden opacity-70"
                    style={{ top, height, backgroundColor: def.color, borderTop: '2px dashed rgba(255,255,255,0.5)' }}
                  >
                    <div className="p-0.5 text-white h-full flex flex-col" style={{ fontSize: '8px' }}>
                      <div className="flex items-center gap-0.5 truncate">
                        <span>{def.emoji}</span>
                        {height > 16 && <span className="truncate">–°–æ–Ω ({totalHours}—á)</span>}
                      </div>
                    </div>
                  </div>
                );
              })()}

              {schedule.map(item => {
                const def = blocks[item.blockId];
                if (!def) return null;
                const startIdx = TIME_SLOTS.findIndex(s => s.hour === item.startHour);
                if (startIdx === -1) return null;
                const top = startIdx * SLOT_HEIGHT;
                const height = (item.duration / 30) * SLOT_HEIGHT - 1;
                const isMoving = movingBlock?.id === item.id;
                const isSleep = item.blockId === 'SLEEP';
                const sleepHours = isSleep ? Math.round(item.duration / 60 * 10) / 10 : 0;

                return (
                  <div
                    key={item.id}
                    onClick={() => setMovingBlock(isMoving ? null : { id: item.id, dateKey })}
                    className={`absolute left-0.5 right-0.5 rounded overflow-hidden cursor-pointer ${isMoving ? 'ring-2 ring-white z-10' : ''}`}
                    style={{ top, height, backgroundColor: def.color, opacity: item.auto ? 0.6 : 1 }}
                  >
                    <div className="p-0.5 text-white h-full flex flex-col" style={{ fontSize: '8px' }}>
                      <div className="flex items-center gap-0.5 truncate">
                        <span>{def.emoji}</span>
                        {height > 16 && <span className="truncate">{def.name}{isSleep ? ` (${sleepHours}—á)` : ''}</span>}
                      </div>
                      {height >= 32 && (
                        <div className="flex items-center justify-between mt-auto">
                          <span className="opacity-70">{item.duration}–º</span>
                          <div className="flex gap-0.5" onClick={e => e.stopPropagation()}>
                            <button onClick={() => resizeBlock(dateKey, item.id, -30)} disabled={item.duration <= def.minDur} className="w-3.5 h-3.5 bg-white/20 rounded disabled:opacity-30">‚àí</button>
                            <button onClick={() => resizeBlock(dateKey, item.id, 30)} disabled={item.duration >= def.maxDur} className="w-3.5 h-3.5 bg-white/20 rounded disabled:opacity-30">+</button>
                            <button onClick={() => removeBlock(dateKey, item.id)} className="w-3.5 h-3.5 bg-red-500/40 rounded">√ó</button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      };

      // Scenario Modal
      const ScenarioModal = ({ dateKey, dayOfWeek, onClose }) => {
        const [scenario, setScenario] = useState('3');
        const [opCount, setOpCount] = useState(2);
        const [contextKey, setContextKey] = useState(weekContexts[dayOfWeek]);
        const date = new Date(dateKey);

        const handleApply = () => {
          // Save context for this day of week
          setWeekContexts(prev => ({ ...prev, [dayOfWeek]: contextKey }));
          applyScenario(dateKey, scenario, opCount, contextKey);
        };

        const handleClear = () => {
          setSchedules(prev => ({ ...prev, [dateKey]: [] }));
          onClose();
        };

        return (
          <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={onClose}>
            <div className="bg-gray-800 rounded-xl p-4 w-full max-w-sm" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg font-bold mb-3 text-center">
                üìÖ {['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'][dayOfWeek]} {date.getDate()}
              </h3>

              {/* Context selector */}
              <div className="mb-4">
                <div className="text-xs text-gray-400 mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–Ω—è:</div>
                <div className="flex gap-1">
                  {Object.entries(CONTEXTS).map(([k, v]) => (
                    <button
                      key={k}
                      onClick={() => setContextKey(k)}
                      className={`flex-1 py-2 rounded text-xs ${contextKey === k ? 'ring-2 ring-white' : ''}`}
                      style={{ backgroundColor: v.color + (contextKey === k ? '' : '44') }}
                    >
                      {v.emoji}
                    </button>
                  ))}
                </div>
              </div>

              {/* Scenario selector */}
              <div className="mb-4">
                <div className="text-xs text-gray-400 mb-1">–ù–æ–º–µ—Ä –≤ –æ—á–µ—Ä–µ–¥–∏:</div>
                <div className="flex gap-1">
                  {Object.entries(SCENARIOS).map(([k, s]) => (
                    <button
                      key={k}
                      onClick={() => setScenario(k)}
                      className={`flex-1 py-2 rounded text-xs ${scenario === k ? 'bg-orange-600' : 'bg-gray-700'}`}
                    >
                      <div className="font-bold">{s.name}</div>
                      <div className="text-gray-300" style={{ fontSize: '8px' }}>{s.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* OP count selector */}
              {scenario !== 'w' && (
                <div className="mb-4">
                  <div className="text-xs text-gray-400 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π:</div>
                  <div className="flex gap-2">
                    {[1, 2, 3].map(n => (
                      <button
                        key={n}
                        onClick={() => setOpCount(n)}
                        className={`flex-1 py-3 rounded text-lg ${opCount === n ? 'bg-red-600' : 'bg-gray-700'}`}
                      >
                        {'üè•'.repeat(n)}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex gap-2">
                <button onClick={handleClear} className="px-4 py-2 bg-gray-700 rounded text-sm">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button onClick={onClose} className="flex-1 py-2 bg-gray-700 rounded text-sm">–û—Ç–º–µ–Ω–∞</button>
                <button onClick={handleApply} className="flex-1 py-2 bg-green-600 rounded text-sm font-bold">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="h-screen flex flex-col bg-gray-900 text-white safe-top">
          {/* Header */}
          <header className="bg-gray-800 border-b border-gray-700 px-2 py-1 shrink-0">
            <div className="flex items-center gap-2">
              <span className="text-lg">ü¶Å</span>
              <button onClick={() => changeWeek(-1)} className="px-2 text-lg">‚Äπ</button>
              <button onClick={goToToday} className="flex-1 text-center text-sm font-bold">
                {weekStart.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })} ‚Äî {weekDays[6].toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })}
              </button>
              <button onClick={() => changeWeek(1)} className="px-2 text-lg">‚Ä∫</button>
            </div>
          </header>

          {/* Tabs */}
          <div className="flex bg-gray-800 border-b border-gray-700 shrink-0">
            {[
              { id: 'plan', label: 'üìÖ' },
              { id: 'triggers', label: '‚ö°' },
              { id: 'goals', label: 'üéØ' },
              { id: 'dump', label: 'üß†' },
            ].map(t => (
              <button key={t.id} onClick={() => setTab(t.id)} className={`flex-1 py-1.5 text-lg ${tab === t.id ? 'bg-orange-600' : 'text-gray-400'}`}>
                {t.label}
              </button>
            ))}
          </div>

          {/* PLAN TAB */}
          {tab === 'plan' && (
            <div className="flex-1 flex flex-col overflow-hidden">
              {/* Selection indicator */}
              {(selectedBlock || movingBlock) && (
                <div className={`px-2 py-0.5 text-center text-xs shrink-0 ${movingBlock ? 'bg-blue-800' : 'bg-green-800'}`}>
                  {movingBlock ? '‚ÜïÔ∏è –¢–∞–ø–Ω–∏ –∫—É–¥–∞' : `${blocks[selectedBlock]?.emoji} –¢–∞–ø–Ω–∏ –Ω–∞ —Å–ª–æ—Ç`}
                </div>
              )}

              {/* Week view */}
              <div className="flex-1 flex overflow-hidden">
                {/* Time labels */}
                <div className="w-5 shrink-0 bg-gray-900 overflow-y-auto no-scrollbar" style={{ paddingTop: '52px' }}>
                  {TIME_SLOTS.map((slot) => (
                    <div key={slot.hour} className={`flex items-center justify-end pr-0.5 ${slot.hour >= 24 ? 'text-purple-400' : slot.isHalf ? 'text-gray-800' : 'text-gray-500'}`} style={{ height: SLOT_HEIGHT, fontSize: '7px' }}>
                      {!slot.isHalf && slot.label}
                    </div>
                  ))}
                </div>

                {/* Days */}
                <div className="flex-1 flex overflow-x-auto overflow-y-auto timeline-scroll">
                  {weekDays.map((day, idx) => {
                    const dk = formatDate(day);
                    const prevDay = new Date(day);
                    prevDay.setDate(prevDay.getDate() - 1);
                    const prevDk = formatDate(prevDay);
                    return <DayColumn key={dk} date={day} dateKey={dk} schedule={schedules[dk] || []} prevSchedule={schedules[prevDk] || []} />;
                  })}
                </div>
              </div>

              {/* Block library - bottom */}
              <div className="bg-gray-800 border-t border-gray-700 p-2 shrink-0 max-h-36 overflow-y-auto">
                <div className="space-y-1.5">
                  {Object.entries(blocksByCategory).map(([cat, catBlocks]) => (
                    <div key={cat}>
                      <div className="text-gray-500 mb-0.5" style={{ fontSize: '9px' }}>{CATEGORIES[cat]?.name}</div>
                      <div className="flex flex-wrap gap-1">
                        {catBlocks.map(b => (
                          <button
                            key={b.id}
                            onClick={() => setSelectedBlock(selectedBlock === b.id ? null : b.id)}
                            onContextMenu={(e) => { e.preventDefault(); setShowBlockEditor(b); }}
                            className={`flex items-center gap-1 px-1.5 py-1 rounded ${selectedBlock === b.id ? 'ring-2 ring-white' : ''}`}
                            style={{ background: selectedBlock === b.id ? b.color : `${b.color}33`, borderLeft: `3px solid ${b.color}`, fontSize: '10px' }}
                          >
                            <span>{b.emoji}</span>
                            <span className="text-white">{b.name}</span>
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* TRIGGERS TAB */}
          {tab === 'triggers' && (() => {
            const triggers = getTriggers(activeScenario, todayDayOfWeek, todayContext);
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è > –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
            const contextProject = getContextFromSchedule || (todayContext === 'POLECHAT' ? 'POLECHAT' : todayContext === 'LAB' ? 'LAB' : todayContext === 'SOMALAB' ? 'SOMALAB' : null);
            const contextDump = contextProject ? brainDump.filter(d => d.project === contextProject) : [];
            const contextGoals = contextProject ? goals.filter(g => g.project === contextProject && !g.done) : [];
            const hasSchedule = (schedules[todayKey] || []).length > 0;

            return (
            <div className="flex-1 overflow-auto p-2 space-y-2 safe-bottom">
              {/* –í—ã–±–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è */}
              <div className="bg-gray-800 rounded-lg p-2">
                <div className="flex items-center justify-between mb-1">
                  <span className="text-xs text-gray-400">–°–µ–≥–æ–¥–Ω—è:</span>
                  <span className="text-xs" style={{ color: CONTEXTS[todayContext]?.color }}>{CONTEXTS[todayContext]?.emoji} {CONTEXTS[todayContext]?.name}</span>
                </div>
                <div className="flex gap-1">
                  {Object.entries(SCENARIOS).map(([k, s]) => (
                    <button key={k} onClick={() => setScenarioForToday(k)} className={`flex-1 py-1.5 rounded text-xs ${activeScenario === k ? 'bg-orange-600' : 'bg-gray-700'}`}>
                      <div className="font-bold">{s.name}</div>
                      <div className="text-gray-300" style={{ fontSize: '8px' }}>{s.desc}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞ ‚Äî –º—ã—Å–ª–∏ + —Ü–µ–ª–∏ + –º–µ—Ç—Ä–∏–∫–∏ */}
              {contextProject && (
                <div className="rounded-lg p-2" style={{ backgroundColor: PROJECTS[contextProject]?.color + '22', border: `1px solid ${PROJECTS[contextProject]?.color}44` }}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-1">
                      <span style={{ color: PROJECTS[contextProject]?.color }}>{PROJECTS[contextProject]?.emoji}</span>
                      <span className="text-sm font-medium">{PROJECTS[contextProject]?.name}</span>
                    </div>
                    <span className="text-xs text-gray-500">{getContextFromSchedule ? 'üìÖ –∏–∑ –ø–ª–∞–Ω–∞' : 'üìÜ –∏–∑ –¥–Ω—è'}</span>
                  </div>

                  {contextDump.length > 0 && (
                    <div className="mb-2">
                      <div className="text-xs text-gray-400 mb-0.5">üß† –ú—ã—Å–ª–∏ ({contextDump.length}):</div>
                      <div className="space-y-0.5">
                        {contextDump.slice(0, 3).map(d => (
                          <div key={d.id} className="text-xs bg-gray-900/50 rounded px-1.5 py-0.5 truncate">{d.text}</div>
                        ))}
                        {contextDump.length > 3 && <div className="text-xs text-gray-500">+{contextDump.length - 3} –µ—â—ë...</div>}
                      </div>
                    </div>
                  )}

                  {contextGoals.length > 0 && (
                    <div className="mb-2">
                      <div className="text-xs text-gray-400 mb-0.5">üéØ –¶–µ–ª–∏:</div>
                      <div className="space-y-0.5">
                        {contextGoals.slice(0, 3).map(g => (
                          <div key={g.id} onClick={() => toggleGoal(g.id)} className="flex items-center gap-1 text-xs bg-gray-900/50 rounded px-1.5 py-0.5 cursor-pointer">
                            <div className="w-3 h-3 rounded border border-gray-600 flex items-center justify-center text-xs"></div>
                            <span className="truncate">{g.text}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {METRICS_CONFIG[contextProject] && (
                    <div>
                      <div className="text-xs text-gray-400 mb-0.5">üìä –ú–µ—Ç—Ä–∏–∫–∏:</div>
                      <div className="flex flex-wrap gap-2 text-xs">
                        {METRICS_CONFIG[contextProject].filter(m => m.type === 'number').slice(0, 2).map(m => (
                          <span key={m.key} className="bg-gray-900/50 rounded px-1.5 py-0.5">
                            {m.label}: {metrics[contextProject]?.[m.key] || 0}{m.target ? `/${m.target}` : ''}
                          </span>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              <div className="bg-gray-800 rounded-lg p-2">
                <div className="text-sm font-bold mb-1">üéØ –§–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏</div>
                <input type="text" value={weekFocus} onChange={(e) => setWeekFocus(e.target.value)} placeholder="–ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å..." className="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm" />
              </div>

              {Object.entries(triggers).map(([key, cat]) => cat && (
                <div key={key} className="bg-gray-800 rounded-lg p-2">
                  <div className="text-xs font-medium mb-1">{cat.title}</div>
                  <div className="grid grid-cols-2 gap-1">
                    {cat.items.map(item => (
                      <div key={item.key} onClick={() => setCheckedTriggers(prev => ({ ...prev, [item.key]: !prev[item.key] }))} className={`flex items-center gap-1 py-0.5 px-1 rounded cursor-pointer ${checkedTriggers[item.key] ? 'bg-green-900/30' : 'hover:bg-gray-700'}`} style={{ fontSize: '10px' }}>
                        <div className={`w-3 h-3 rounded border flex items-center justify-center ${checkedTriggers[item.key] ? 'bg-green-600 border-green-600' : 'border-gray-600'}`}>
                          {checkedTriggers[item.key] && <span style={{ fontSize: '8px' }}>‚úì</span>}
                        </div>
                        <span className="text-gray-400">{item.event}</span>
                        <span className="text-gray-600">‚Üí</span>
                        <span>{item.action}</span>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
              <button onClick={() => setCheckedTriggers({})} className="w-full py-1 text-xs text-gray-500">–°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã</button>
              <div className="bg-orange-900/20 border border-orange-800 rounded p-2 text-xs text-orange-200 italic">
                "–ü–æ–∫–∞–∑–∞–ª –∑–∞–¥–∞—á—É, –æ—Ç–æ—à—ë–ª. –ó–∞—Ö–≤–∞—Ç–∏–ª–æ ‚Äî –µ–¥—É."
              </div>
            </div>
          );})()}

          {/* GOALS TAB */}
          {tab === 'goals' && (
            <div className="flex-1 overflow-auto p-2 space-y-2 safe-bottom">
              <div className="bg-gray-800 rounded-lg p-2 space-y-1">
                <input type="text" value={newGoalText} onChange={(e) => setNewGoalText(e.target.value)} placeholder="–ù–æ–≤–∞—è —Ü–µ–ª—å..." className="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm" onKeyDown={(e) => e.key === 'Enter' && addGoal()} />
                <div className="flex gap-1">
                  <select value={newGoalProject} onChange={(e) => setNewGoalProject(e.target.value)} className="flex-1 bg-gray-900 border border-gray-700 rounded px-1 py-0.5 text-xs">
                    <option value="">–ü—Ä–æ–µ–∫—Ç</option>
                    {Object.entries(PROJECTS).map(([k, v]) => <option key={k} value={k}>{v.emoji} {v.name}</option>)}
                  </select>
                  <select value={newGoalPeriod} onChange={(e) => setNewGoalPeriod(e.target.value)} className="flex-1 bg-gray-900 border border-gray-700 rounded px-1 py-0.5 text-xs">
                    <option value="">–ü–µ—Ä–∏–æ–¥</option>
                    <option value="D">–î–µ–Ω—å</option>
                    <option value="W">–ù–µ–¥–µ–ª—è</option>
                    <option value="M">–ú–µ—Å—è—Ü</option>
                    <option value="Q">–ö–≤–∞—Ä—Ç–∞–ª</option>
                  </select>
                  <button onClick={addGoal} className="px-2 py-0.5 bg-orange-600 rounded text-xs font-bold">+</button>
                </div>
              </div>

              {/* –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º */}
              <div className="flex gap-1 flex-wrap">
                <button onClick={() => setGoalsFilter('')} className={`px-2 py-0.5 rounded text-xs ${goalsFilter === '' ? 'bg-orange-600' : 'bg-gray-700'}`}>–í—Å–µ</button>
                {Object.entries(PROJECTS).map(([k, v]) => (
                  <button key={k} onClick={() => setGoalsFilter(k)} className={`px-2 py-0.5 rounded text-xs ${goalsFilter === k ? 'bg-orange-600' : 'bg-gray-700'}`} style={{ borderLeft: `3px solid ${v.color}` }}>
                    {v.emoji}
                  </button>
                ))}
              </div>

              {/* –ú–µ—Ç—Ä–∏–∫–∏ */}
              {goalsFilter && METRICS_CONFIG[goalsFilter] && (
                <div className="bg-gray-800 rounded-lg p-2">
                  <div className="flex items-center gap-1 mb-1">
                    <span style={{ color: PROJECTS[goalsFilter]?.color }}>{PROJECTS[goalsFilter]?.emoji}</span>
                    <span className="text-xs font-medium">–ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ–¥–µ–ª–∏</span>
                  </div>
                  <div className="space-y-1">
                    {METRICS_CONFIG[goalsFilter].map(m => (
                      <div key={m.key} className="flex items-center gap-2">
                        <span className="text-xs text-gray-400 flex-1">{m.label}</span>
                        {m.type === 'number' && (
                          <div className="flex items-center gap-1">
                            <button onClick={() => updateMetric(goalsFilter, m.key, Math.max(0, (metrics[goalsFilter]?.[m.key] || 0) - 1))} className="w-5 h-5 bg-gray-700 rounded text-xs">‚àí</button>
                            <span className="w-6 text-center text-sm">{metrics[goalsFilter]?.[m.key] || 0}</span>
                            <button onClick={() => updateMetric(goalsFilter, m.key, (metrics[goalsFilter]?.[m.key] || 0) + 1)} className="w-5 h-5 bg-gray-700 rounded text-xs">+</button>
                            {m.target && <span className="text-xs text-gray-500">/ {m.target}</span>}
                          </div>
                        )}
                        {m.type === 'text' && (
                          <input type="text" value={metrics[goalsFilter]?.[m.key] || ''} onChange={(e) => updateMetric(goalsFilter, m.key, e.target.value)} className="w-24 bg-gray-900 border border-gray-700 rounded px-1 py-0.5 text-xs" placeholder="..." />
                        )}
                        {m.type === 'checkbox' && (
                          <button onClick={() => updateMetric(goalsFilter, m.key, !metrics[goalsFilter]?.[m.key])} className={`w-5 h-5 rounded border flex items-center justify-center text-xs ${metrics[goalsFilter]?.[m.key] ? 'bg-green-600 border-green-600' : 'border-gray-600'}`}>
                            {metrics[goalsFilter]?.[m.key] && '‚úì'}
                          </button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {[{ key: 'D', label: 'üìÖ –î–µ–Ω—å' }, { key: 'W', label: 'üìÜ –ù–µ–¥–µ–ª—è' }, { key: 'M', label: 'üóì –ú–µ—Å—è—Ü' }, { key: 'Q', label: 'üéØ –ö–≤–∞—Ä—Ç–∞–ª' }, { key: 'other', label: 'üìå' }].map(p => {
                const filteredGoals = goalsByPeriod[p.key].filter(g => !goalsFilter || g.project === goalsFilter);
                return filteredGoals.length > 0 && (
                <div key={p.key}>
                  <div className="text-xs text-gray-500 mb-0.5">{p.label}</div>
                  <div className="space-y-0.5">
                    {filteredGoals.map(g => (
                      <div key={g.id} className={`flex items-center gap-1 p-1.5 rounded ${g.done ? 'bg-green-900/20' : 'bg-gray-800'}`}>
                        <button onClick={() => toggleGoal(g.id)} className={`w-4 h-4 rounded border flex items-center justify-center text-xs ${g.done ? 'bg-green-600 border-green-600' : 'border-gray-600'}`}>{g.done && '‚úì'}</button>
                        <div className={`flex-1 text-sm truncate ${g.done ? 'line-through text-gray-500' : ''}`}>{g.text}</div>
                        {g.project && <span style={{ backgroundColor: PROJECTS[g.project]?.color, fontSize: '10px' }} className="px-1 rounded">{PROJECTS[g.project]?.emoji}</span>}
                        <button onClick={() => deleteGoal(g.id)} className="text-gray-600 hover:text-red-400 text-xs">‚úï</button>
                      </div>
                    ))}
                  </div>
                </div>
              )})}
            </div>
          )}

          {/* BRAIN DUMP TAB */}
          {tab === 'dump' && (
            <div className="flex-1 overflow-auto p-2 space-y-2 safe-bottom">
              <div className="bg-gray-800 rounded-lg p-2 space-y-1">
                <div className="flex gap-1">
                  <input type="text" value={newDumpText} onChange={(e) => setNewDumpText(e.target.value)} placeholder="–ú—ã—Å–ª—å, –∏–¥–µ—è, –∑–∞–¥–∞—á–∞..." className="flex-1 bg-gray-900 border border-gray-700 rounded px-2 py-1 text-sm" onKeyDown={(e) => e.key === 'Enter' && addDump()} />
                  <button onClick={addDump} className="px-3 py-1 bg-orange-600 rounded font-bold">+</button>
                </div>
                <select value={newDumpProject} onChange={(e) => setNewDumpProject(e.target.value)} className="w-full bg-gray-900 border border-gray-700 rounded px-2 py-1 text-xs">
                  <option value="">–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞</option>
                  {Object.entries(PROJECTS).map(([k, v]) => <option key={k} value={k}>{v.emoji} {v.name}</option>)}
                </select>
              </div>

              {/* –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º */}
              <div className="flex gap-1 flex-wrap">
                <button onClick={() => setDumpFilter('')} className={`px-2 py-0.5 rounded text-xs ${dumpFilter === '' ? 'bg-orange-600' : 'bg-gray-700'}`}>–í—Å–µ</button>
                {Object.entries(PROJECTS).map(([k, v]) => (
                  <button key={k} onClick={() => setDumpFilter(k)} className={`px-2 py-0.5 rounded text-xs ${dumpFilter === k ? 'bg-orange-600' : 'bg-gray-700'}`} style={{ borderLeft: `3px solid ${v.color}` }}>
                    {v.emoji}
                  </button>
                ))}
              </div>

              <div className="space-y-0.5">
                {brainDump.filter(item => !dumpFilter || item.project === dumpFilter).map(item => (
                  <div key={item.id} className="flex items-center gap-1 p-1.5 bg-gray-800 rounded group">
                    {item.project && <span style={{ backgroundColor: PROJECTS[item.project]?.color, fontSize: '10px' }} className="px-1 rounded shrink-0">{PROJECTS[item.project]?.emoji}</span>}
                    <div className="flex-1 text-sm truncate">{item.text}</div>
                    <button onClick={() => convertToGoal(item)} className="text-xs text-blue-400 opacity-60 hover:opacity-100">‚ÜíüéØ</button>
                    <button onClick={() => deleteDump(item.id)} className="text-xs text-gray-500 opacity-60 hover:opacity-100">‚úï</button>
                  </div>
                ))}
              </div>
              {brainDump.filter(item => !dumpFilter || item.project === dumpFilter).length === 0 && <div className="text-center text-gray-600 py-4 text-sm">{dumpFilter ? '–ù–µ—Ç –º—ã—Å–ª–µ–π –ø–æ —ç—Ç–æ–º—É –ø—Ä–æ–µ–∫—Ç—É' : '–í—ã–≥—Ä—É–∑–∏ –≤—Å—ë –∏–∑ –≥–æ–ª–æ–≤—ã ‚Üë'}</div>}
            </div>
          )}

          {/* Scenario Modal */}
          {showScenarioModal && (
            <ScenarioModal 
              dateKey={showScenarioModal.dateKey} 
              dayOfWeek={showScenarioModal.dayOfWeek}
              onClose={() => setShowScenarioModal(null)} 
            />
          )}

          {/* Block Editor */}
          {showBlockEditor && (
            <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setShowBlockEditor(null)}>
              <div className="bg-gray-800 rounded-xl p-4 w-full max-w-xs" onClick={e => e.stopPropagation()}>
                <h3 className="text-sm font-bold mb-3">‚úèÔ∏è {showBlockEditor.name}</h3>
                <div className="space-y-2">
                  <div className="flex gap-2">
                    <input type="text" value={showBlockEditor.emoji} onChange={e => setShowBlockEditor({...showBlockEditor, emoji: e.target.value})} className="w-16 bg-gray-700 rounded px-2 py-1 text-xl text-center" />
                    <input type="color" value={showBlockEditor.color} onChange={e => setShowBlockEditor({...showBlockEditor, color: e.target.value})} className="flex-1 h-10 bg-gray-700 rounded cursor-pointer" />
                  </div>
                  <input type="text" value={showBlockEditor.name} onChange={e => setShowBlockEditor({...showBlockEditor, name: e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1 text-sm" />
                  <div className="flex gap-2 text-xs">
                    <div className="flex-1"><label className="text-gray-400">–î–ª–∏—Ç</label><input type="number" value={showBlockEditor.duration} onChange={e => setShowBlockEditor({...showBlockEditor, duration: +e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1" /></div>
                    <div className="flex-1"><label className="text-gray-400">Min</label><input type="number" value={showBlockEditor.minDur} onChange={e => setShowBlockEditor({...showBlockEditor, minDur: +e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1" /></div>
                    <div className="flex-1"><label className="text-gray-400">Max</label><input type="number" value={showBlockEditor.maxDur} onChange={e => setShowBlockEditor({...showBlockEditor, maxDur: +e.target.value})} className="w-full bg-gray-700 rounded px-2 py-1" /></div>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  <button onClick={() => setShowBlockEditor(null)} className="flex-1 py-1.5 bg-gray-700 rounded text-sm">–û—Ç–º–µ–Ω–∞</button>
                  <button onClick={() => { setBlocks(prev => ({ ...prev, [showBlockEditor.id]: showBlockEditor })); setShowBlockEditor(null); }} className="flex-1 py-1.5 bg-green-600 rounded text-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<LevOS />);
  </script>
</body>
</html>
